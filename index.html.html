<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Finanzas Personales Sanas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@700;900&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --color-primary: #863399; /* Purple */
            --color-secondary: #E7004C; /* Pink/Magenta */
            --font-title: 'League Spartan', sans-serif;
            --font-text: 'Montserrat', sans-serif;

            /* Dynamic result colors */
            --color-level-1: #EF4444; /* red-500 (Rescate) */
            --color-level-2: #F97316; /* orange-500 (Despertar) */
            --color-level-3: #EAB308; /* yellow-500 (Camino) */
            --color-level-4: #84CC16; /* lime-500 (Potenciando) */
            --color-level-5: #22C55E; /* green-500 (Maestro) */

            /* CTA Button Colors */
            --color-cta-achieved-bg: #D1FAE5; /* green-100 */
            --color-cta-achieved-text: #065F46; /* green-800 */
            --color-cta-achieved-border: #6EE7B7; /* green-300 */
            --color-cta-achieved-hover-bg: #A7F3D0; /* green-200 */
            --color-cta-achieved-active-bg: #10B981; /* green-500 */
            --color-cta-achieved-active-text: white;

            --color-cta-not-achieved-bg: #FEE2E2; /* red-100 */
            --color-cta-not-achieved-text: #991B1B; /* red-800 */
            --color-cta-not-achieved-border: #FCA5A5; /* red-300 */
            --color-cta-not-achieved-hover-bg: #FECACA; /* red-200 */
            --color-cta-not-achieved-active-bg: #EF4444; /* red-500 */
            --color-cta-not-achieved-active-text: white;
        }

        html {
            scroll-behavior: smooth; 
        }

        body {
            font-family: var(--font-text);
            background-color: #f0f4f8; 
            color: #333;
            min-height: 100vh; 
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-title);
            color: var(--color-primary);
            font-weight: 700; 
        }
        .font-league-spartan-black {
            font-family: var(--font-title);
            font-weight: 900; 
        }

        .quiz-container {
            max-width: 900px; 
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .question-section-layout {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 1.5rem; 
        }
        @media (min-width: 768px) { 
            .question-section-layout {
                grid-template-columns: 1fr 2fr; 
            }
        }
        .section-info-column h2 {
            font-size: 1.75rem; 
            margin-bottom: 0.5rem;
        }
        .section-info-column p {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.6;
        }

        .question-block { 
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #f8fafc;
        }
        .option-label {
            display: block;
            padding: 0.85rem 1.25rem;
            margin-bottom: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            background-color: white;
            font-family: var(--font-text);
            font-size: 0.95rem;
        }
        .option-label:hover {
            border-color: var(--color-primary);
        }
        .option-label.selected {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        .option-label input[type="radio"] {
            margin-right: 0.75rem;
            accent-color: var(--color-secondary); 
        }
        .option-label.selected input[type="radio"] {
             filter: brightness(0) invert(1); 
        }

        .btn {
            padding: 0.85rem 1.75rem;
            border-radius: 8px; 
            font-family: var(--font-title);
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s, color 0.2s, border-color 0.2s;
            cursor: pointer;
            text-align: center;
            text-transform: uppercase; 
            letter-spacing: 0.05em;
            border: none;
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: #702b82; 
        }
        .btn-secondary { 
            background-color: #e2e8f0;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        .btn-success { 
            background-color: var(--color-secondary);
            color: white;
        }
        .btn-success:hover {
            background-color: #c4003f; 
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            margin-bottom: 1rem; 
            height: 12px;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--color-secondary); 
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        
        .input-field { 
            font-family: var(--font-text);
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
            background-color: white; 
        }
        .input-field:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(134, 51, 153, 0.3);
        }

        /* Results Screen Specific Styles */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            align-items: flex-start;
            margin-bottom: 2rem; 
        }
        @media (min-width: 768px) { 
            .results-grid {
                grid-template-columns: 1.2fr 1fr; 
            }
        }
        .module-results-chart h3, .patrimonial-results-display h3, .results-legend-container h3 { 
            font-family: var(--font-title);
            font-weight: 700;
            font-size: 1.5rem; 
            color: white;
            background-color: var(--color-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .bar-chart-item {
            margin-bottom: 1rem;
            font-family: var(--font-text);
        }
        .bar-chart-label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #4A5568; 
        }
        .bar-container {
            background-color: #E2E8F0; 
            border-radius: 4px;
            height: 28px; 
            width: 100%;
            position: relative;
            overflow: hidden; 
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out, background-color 0.5s ease-out; 
            display: flex;
            align-items: center;
            justify-content: flex-end; 
            padding-right: 8px; 
            box-sizing: border-box;
        }
         .bar-percentage-text {
            font-size: 0.8rem;
            color: white;
            font-weight: 600;
        }

        .overall-result-display {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .overall-result-display p {
             font-family: var(--font-text);
             font-size: 1.125rem; 
             color: #4A5568; 
             margin-bottom: 0.5rem;
        }
        .overall-percentage-box {
            color: white;
            font-family: var(--font-title);
            font-weight: 900;
            font-size: 3rem; 
            padding: 1.5rem 1rem;
            border-radius: 12px;
            display: inline-block;
            min-width: 120px; 
            line-height: 1;
            margin-bottom: 1.5rem;
            transition: background-color 0.5s ease-out;
        }
        .results-message-container { 
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
        }
         .results-message-container h3 { 
            font-size: 1.75rem; 
            color: var(--color-primary); 
            margin-bottom: 0.75rem;
        }
        .results-message-container p {
            font-family: var(--font-text);
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .patrimonial-results-display { 
            background-color: #f8fafc; 
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            width: 100%; 
            margin-top: 1rem; 
            text-align: center; 
        }
        .patrimonial-results-display .numero-magico {
            font-family: var(--font-title);
            font-weight: 900;
            font-size: 3.5rem; 
            color: var(--color-secondary);
            text-align: center;
            margin-bottom: 0.5rem; 
            line-height: 1.1;
        }
         .patrimonial-results-display .numero-magico-label {
            font-family: var(--font-text);
            font-size: 1rem;
            color: #555;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .patrimonial-results-display p { 
            font-family: var(--font-text);
            font-size: 0.95rem; 
            color: #333;
            line-height: 1.6;
            margin-bottom: 0.75rem;
            text-align: left; 
        }
        .patrimonial-results-display .text-xs { 
            font-size: 0.8rem;
            color: #555;
            text-align: left;
        }
        .patrimonial-cta-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .patrimonial-cta-buttons .btn { /* Base style for CTA buttons */
            border: 2px solid transparent; /* Base border */
        }
        .btn-cta-achieved {
            background-color: var(--color-cta-achieved-bg);
            color: var(--color-cta-achieved-text);
            border-color: var(--color-cta-achieved-border);
        }
        .btn-cta-achieved:hover {
            background-color: var(--color-cta-achieved-hover-bg);
        }
        .btn-cta-achieved.active, .btn-cta-achieved:active {
            background-color: var(--color-cta-achieved-active-bg);
            color: var(--color-cta-achieved-active-text);
            border-color: var(--color-cta-achieved-active-bg);
        }
        .btn-cta-not-achieved {
            background-color: var(--color-cta-not-achieved-bg);
            color: var(--color-cta-not-achieved-text);
            border-color: var(--color-cta-not-achieved-border);
        }
        .btn-cta-not-achieved:hover {
            background-color: var(--color-cta-not-achieved-hover-bg);
        }
        .btn-cta-not-achieved.active, .btn-cta-not-achieved:active {
            background-color: var(--color-cta-not-achieved-active-bg);
            color: var(--color-cta-not-achieved-active-text);
            border-color: var(--color-cta-not-achieved-active-bg);
        }


        @media (min-width: 640px) { 
            .patrimonial-cta-buttons {
                flex-direction: row;
                justify-content: center;
            }
            .patrimonial-cta-buttons .btn {
                width: auto;
            }
        }
        .motivational-text {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            background-color: #eef2ff; 
            border: 1px solid #c7d2fe; 
            color: #4338ca; 
            font-family: var(--font-text);
            font-size: 0.95rem;
            line-height: 1.6;
            text-align: left;
        }


        .results-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-family: var(--font-text);
            font-size: 0.9rem;
        }
        .legend-color-swatch {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            margin-right: 0.75rem;
            border: 1px solid rgba(0,0,0,0.1);
        }


        /* Loading Spinner */
        .spinner-overlay { 
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--color-primary);
            animation: spin 1s ease infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Responsive adjustments */
        @media (max-width: 767px) { 
            .quiz-container {
                margin: 1rem;
                padding: 1.5rem;
            }
            .question-block { 
                padding: 1rem;
            }
            .btn {
                width: 100%;
                margin-top: 0.75rem;
                padding: 1rem 1.5rem; 
            }
             .navigation-buttons .btn-secondary { 
                margin-bottom: 0.5rem;
            }
            .results-buttons-container .btn {
                 margin-bottom: 0.75rem;
            }
            .section-info-column {
                margin-bottom: 1rem; 
            }
            .results-grid {
                grid-template-columns: 1fr; 
            }
            .patrimonial-results-display .numero-magico {
                font-size: 2.5rem; 
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="quizApp" class="quiz-container">
        <div id="initialScreen">
            <img src="https://img1.wsimg.com/isteam/ip/5a112341-ad0f-4890-9c15-42df6c8fd70f/icon%20Initial.png/:/rs=h:175,m" alt="Icono del test de finanzas" class="mx-auto mb-6 h-20 w-auto">
            <h1 class="text-4xl font-league-spartan-black text-center mb-6">¡Evalúa tu Salud Financiera Hoy!</h1>
            <p class="text-lg text-center mb-8 leading-relaxed" style="font-family: var(--font-text);">Este test rápido y sencillo te dará una visión clara de tu situación financiera actual. ¡No necesitas ser un experto, solo responder con honestidad!</p>
            <button id="startQuizBtn" class="btn btn-primary w-full sm:w-auto mx-auto block text-lg">¡Empezar el Test!</button>
        </div>
        
        <div id="disclaimerScreen" class="hidden">
            <h2 class="text-3xl font-league-spartan-black text-center mb-6">Antes de Comenzar</h2>
            <div class="space-y-4 text-sm text-gray-700 leading-relaxed" style="font-family: var(--font-text);">
                <p>Este test de finanzas personales es una herramienta interactiva diseñada para ofrecerte una perspectiva general y educativa sobre tu situación financiera actual. Los resultados y recomendaciones proporcionados pretenden servir como una guía inicial y un punto de partida para tu planificación financiera.</p>
                <p><strong>Importante:</strong> La información generada por este test no constituye, bajo ninguna circunstancia, asesoramiento financiero profesional, legal o fiscal. Cada situación financiera es única, y las decisiones importantes deben tomarse en consulta con profesionales calificados que puedan analizar tu contexto particular.</p>
                <p>Los datos personales que ingreses a continuación, como tu nombre y edad, se utilizan únicamente con el fin de personalizar tu experiencia dentro de este test y para los cálculos presentados. <strong>No almacenamos ni compartimos esta información personal.</strong> Tu privacidad es importante para nosotros.</p>
                <p>Al continuar, aceptas que comprendes estas limitaciones y utilizas esta herramienta bajo tu propia responsabilidad.</p>
            </div>
            <button id="acceptDisclaimerBtn" class="btn btn-primary w-full sm:w-auto mx-auto block mt-8 text-lg">Aceptar y Continuar</button>
        </div>


        <div id="personalDataScreen" class="hidden">
            <div class="question-section-layout">
                <div class="section-info-column">
                    <h2 class="font-league-spartan-black">Información Personal</h2>
                    <p>Un poco sobre ti nos ayudará a personalizar tu análisis y las recomendaciones que recibirás al final del test.</p>
                </div>
                <div id="personalDataQuestionsContainer">
                    </div>
            </div>
            <div class="navigation-buttons flex flex-col sm:flex-row justify-between items-center mt-8">
                 <button id="backBtnPersonalData" class="btn btn-secondary"> &lt; Regresar</button>
                <button id="startMainQuizBtn" class="btn btn-primary">Continuar al Test</button>
            </div>
        </div>

        <div id="quizScreen" class="hidden">
            <div id="quizHeader" class="mb-6"> 
                 <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
                </div>
                <p id="sectionCounter" class="text-sm text-gray-500 text-center" style="font-family: var(--font-text);"></p>
            </div>

            <div class="question-section-layout">
                <div class="section-info-column">
                    <h2 id="sectionTitle" class="font-league-spartan-black"></h2>
                    <p id="sectionSubtitle" style="font-family: var(--font-text);"></p>
                </div>
                <div id="allQuestionsContainer"> 
                    </div>
            </div>
            <p id="selectionError" class="text-red-500 text-sm mt-4 text-center hidden">Por favor, responde todas las preguntas de esta sección.</p>
            <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between items-center mt-8">
                <button id="backBtnQuiz" class="btn btn-secondary"> &lt; Regresar</button>
                <button id="nextSectionBtn" class="btn btn-primary">Siguiente</button> 
            </div>
        </div>

        <div id="patrimonialObjectiveInputScreen" class="hidden"> 
            <h2 class="text-3xl font-league-spartan-black text-center mb-4">¡Ya casi terminas!</h2>
            <p class="text-center text-gray-700 mb-2 text-lg" style="font-family: var(--font-text);">¿Qué tan relacionados están tus hábitos financieros con la acumulación de tu patrimonio?</p>
            <p class="text-sm text-center text-gray-600 mb-8 leading-relaxed" style="font-family: var(--font-text);">Existe una fórmula que te sirve como punto de referencia para calcular cuál es el valor ideal de tus activos financieros que deberías tener en este momento, así te puedes dar una estimación de qué tanto has avanzado en tu planificación financiera, ¿Te atreves a conocer tus resultados?</p>
            
            <div class="space-y-6 mb-8"> 
                <div>
                    <label for="currentAge" class="block text-md font-semibold text-gray-700 mb-1" style="font-family: var(--font-text);">Tu edad actual (entre 18 y 70 años):</label>
                    <input type="number" id="currentAge" name="currentAge" class="input-field shadow-sm" placeholder="Ej: 30" min="18" max="70">
                </div>
                <div>
                    <label for="avgMonthlyIncome" class="block text-md font-semibold text-gray-700 mb-1" style="font-family: var(--font-text);">Tu ingreso mensual promedio (MXN):</label>
                    <input type="number" id="avgMonthlyIncome" name="avgMonthlyIncome" class="input-field shadow-sm" placeholder="Ej: 25000">
                </div>
                <div id="investorProfileQuestionContainer">
                    </div>
            </div>
            <p id="investorProfileError" class="text-red-500 text-sm mt-2 text-center hidden">Por favor, selecciona tu perfil de inversionista.</p>
            <div class="navigation-buttons flex flex-col sm:flex-row justify-between items-center mt-10"> 
                 <button id="backBtnPatrimonialInput" class="btn btn-secondary"> &lt; Regresar</button>
                 <button id="generateReportBtn" class="btn btn-primary">Generar Mi Reporte</button> 
            </div>
        </div>
        
        <div id="loadingScreen" class="spinner-overlay hidden"> 
            <div class="spinner"></div>
            <p class="text-xl font-league-spartan-black" style="color: var(--color-primary);">Generando reporte...</p>
        </div>


        <div id="resultsScreen" class="hidden">
            <h1 id="resultsScreenTitle" class="text-4xl font-league-spartan-black text-center mb-8">¡Tus Resultados Están Aquí!</h1>
            <div class="results-grid">
                <div class="module-results-chart">
                    <h3>Resultados por módulos</h3>
                    <div id="moduleChartContainer">
                        </div>
                </div>
                <div class="overall-results-summary">
                    <div class="overall-result-display">
                        <p>Tu resultado general es:</p>
                        <div id="overallPercentageBox" class="overall-percentage-box">
                            <span id="scorePercentage">0%</span>
                        </div>
                    </div>
                    <div id="resultsMessageContainer" class="results-message-container">
                        <h3 id="resultsTitle" class="font-league-spartan-black"></h3> 
                        <p id="resultsComment"></p>
                        <p id="resultsRecommendation" class="font-semibold"></p>
                    </div>
                </div>
            </div>
            <div id="finalPatrimonialResultsContainer" class="patrimonial-results-display mt-8">
                 </div>

            <div id="resultsLegendContainer" class="results-legend-container mt-8 pt-6 border-t border-gray-300">
                 <h3>Guía de Niveles y Colores</h3>
                 <div id="legendItemsContainer" class="mt-4 space-y-2">
                     </div>
            </div>

            <div class="mt-10 flex flex-col sm:flex-row justify-center sm:space-x-4 results-buttons-container">
                <button id="restartQuizBtn" class="btn btn-primary">Volver a Empezar</button>
                <button id="downloadPdfBtn" class="btn btn-success">Descargar PDF</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration and Data ---
        const quizConfig = {
            loadingDelay: 1500, 
        };

        const personalDataQuestions = [ 
             {
                id: "nombre", question: "¿Cuál es tu nombre?", type: "text", name: "nombre", placeholder: "Escribe tu nombre aquí"
            },
            {
                id: "edad", question: "¿Cuántos años tienes?", type: "radio", name: "edad",
                options: ["18 a 24 años", "25 a 34 años", "35 a 44 años", "45 a 54 años", "55 años o más"]
            },
            {
                id: "dependientes", question: "¿Tienes dependientes económicos?", type: "radio", name: "dependientes",
                options: ["Sí", "No"]
            },
            {
                id: "vivienda", question: "¿Vives en casa propia o rentada?", type: "radio", name: "vivienda",
                options: ["Propia", "Rentada"]
            },
            {
                id: "transporte", question: "¿Qué tipo de transporte utilizas?", type: "radio", name: "transporte",
                options: ["Auto propio", "Transporte público", "Otro"]
            },
            {
                id: "preocupacion", question: "¿Cuál es tu principal preocupación respecto al dinero?", type: "radio", name: "preocupacion",
                options: [
                    "Me preocupa no tener un control claro de mis ingresos y gastos.",
                    "Me preocupa no estar ahorrando lo suficiente para mis metas.",
                    "Me preocupa tener demasiadas deudas o no saber cómo manejar mi crédito.",
                    "Me preocupa no saber cómo invertir mi dinero para hacerlo crecer.",
                    "Me preocupa no estar preparado financieramente para mi retiro.",
                    "Me preocupa no tener la protección adecuada en caso de imprevistos."
                ]
            }
        ];

        const investorProfileQuestion = {
            id: "investorProfile",
            question: "Al invertir tu dinero, ¿cuál de las siguientes afirmaciones describe mejor tu actitud hacia el riesgo y el rendimiento?",
            options: [
                { text: "Prefiero la seguridad ante todo. Busco proteger mi capital, aunque eso signifique obtener rendimientos modestos pero estables.", rate: 0.06, profileName: "Conservador" },
                { text: "Busco un equilibrio entre seguridad y crecimiento. Estoy dispuesto/a a asumir un nivel de riesgo bajo a moderado para obtener rendimientos un poco mayores.", rate: 0.08, profileName: "Moderado" },
                { text: "Estoy enfocado/a en el crecimiento de mi capital a largo plazo. Acepto un nivel de riesgo moderado a alto para buscar rendimientos significativos.", rate: 0.10, profileName: "Crecimiento" },
                { text: "Mi principal objetivo es maximizar mis rendimientos. Estoy dispuesto/a a asumir un alto nivel de riesgo para tener la oportunidad de obtener ganancias elevadas.", rate: 0.12, profileName: "Agresivo" }
            ]
        };


        const quizSections = [ /* ... same as before, ensure 'title' and 'fullTitle' are present ... */ 
            {
                title: "Presupuesto", 
                fullTitle: "Presupuesto - Tu Mapa Financiero Personal",
                subtitle: "Un presupuesto sólido es la base para alcanzar tus sueños financieros. ¡Descubre qué tan bien estás gestionando tus ingresos y gastos!",
                questions: [
                    {
                        id: "presupuesto1", text: "¿Tienes un sistema claro para llevar el registro de tus ingresos y gastos?",
                        options: [
                            { text: "¡Por supuesto! Llevo un registro detallado a diario, reviso mis finanzas cada semana y hago un análisis profundo al final de cada mes. Tengo una visión clara de dónde va cada peso.", score: 3 },
                            { text: "Intento registrar todo, pero a veces se me escapan algunos gastos. Hago revisiones mensuales cuando puedo.", score: 2 },
                            { text: "Solo registro los gastos importantes de vez en cuando. No tengo un sistema muy definido.", score: 1 },
                            { text: "No llevo ningún registro. Simplemente gasto según necesito.", score: 0 }
                        ]
                    },
                    {
                        id: "presupuesto2", text: "¿Tu presupuesto es un plan de acción que realmente sigues?",
                        options: [
                            { text: "Mi presupuesto es mi hoja de ruta financiera. Cada mes, asigno fondos a gastos fijos, metas, ahorro de emergencia y disfrute personal, y me apego a él rigurosamente.", score: 3 },
                            { text: "Tengo un presupuesto para gastos esenciales y personales, y generalmente trato de respetarlo.", score: 2 },
                            { text: "Hago un presupuesto en mi cabeza, pero a menudo termino gastando más de lo previsto.", score: 1 },
                            { text: "No tengo presupuesto. Gasto según lo que tengo disponible en el momento.", score: 0 }
                        ]
                    },
                    {
                        id: "presupuesto3", text: "¿Vives consistentemente por debajo de tus posibilidades?",
                        options: [
                            { text: "Sí, siempre. Mi objetivo es que mis ingresos superen mis gastos para poder ahorrar e invertir. Tengo un colchón financiero saludable.", score: 3 },
                            { text: "Generalmente, mis ingresos cubren mis gastos, aunque hay meses en que llego justo.", score: 2 },
                            { text: "A veces mis gastos superan mis ingresos, especialmente cuando hay imprevistos.", score: 1 },
                            { text: "Casi siempre gasto más de lo que gano. Suelo depender de tarjetas de crédito o préstamos.", score: 0 }
                        ]
                    }
                ]
            },
            {
                title: "Ahorro",
                fullTitle: "Ahorro - El Pilar de tu Futuro",
                subtitle: "Construye tu seguridad financiera paso a paso. Descubre si tus hábitos de ahorro te están llevando hacia tus metas.",
                questions: [
                    {
                        id: "ahorro1", text: "¿Dónde guardas principalmente tus ahorros?",
                        options: [
                            { text: "Ahorro en instituciones financieras reguladas que ofrecen rendimientos.", score: 3 },
                            { text: "Solo guardo mi dinero en la cuenta de débito o nómina.", score: 2 },
                            { text: "Ahorro en casa o en métodos informales como \"tandas\".", score: 1 },
                            { text: "No ahorro.", score: 0 }
                        ]
                    },
                    {
                        id: "ahorro2", text: "¿Cómo priorizas el ahorro en tu presupuesto?",
                        options: [
                            { text: "Ahorro antes de gastar, separando una cantidad fija primero.", score: 3 },
                            { text: "Ahorro después de gastar, si sobra algo, aunque lo hago cada mes.", score: 2 },
                            { text: "Ahorro solo si me sobra dinero después de gastar, \"¡Me lo merezco!\".", score: 1 },
                            { text: "Definitivamente no ahorro.", score: 0 }
                        ]
                    },
                    {
                        id: "ahorro3", text: "¿Alguna vez has usado tus ahorros para cubrir gastos imprevistos o \"gustos\"?",
                        options: [
                            { text: "Nunca uso mis ahorros como \"caja chica\" y los invierto para evitar tentaciones.", score: 3 },
                            { text: "En algunas ocasiones he tomado de mis ahorros, pero trato de reponerlo, aunque no siempre lo logro.", score: 2 },
                            { text: "A pesar de tener ahorros en casa, nunca los he usado para imprevistos o gustos.", score: 1 },
                            { text: "Casi siempre que tengo ahorros, termino gastándolos.", score: 0 }
                        ]
                    }
                ]
            },
            {
                title: "Crédito",
                fullTitle: "Crédito - Tu Herramienta Financiera",
                subtitle: "Aprende a usar el crédito a tu favor. Explora tus hábitos crediticios y descubre cómo optimizar tus deudas.",
                questions: [
                    {
                        id: "credito1", text: "Antes de solicitar un crédito, ¿qué haces?",
                        options: [
                            { text: "Calculo mi capacidad de pago, registrando mis ingresos y gastos detalladamente.", score: 3 },
                            { text: "Trato de calcularlo regularmente, pero a veces olvido algunos gastos.", score: 2 },
                            { text: "Pocas veces calculo mi capacidad de pago, solo para gastos o ingresos importantes.", score: 1 },
                            { text: "No hago ningún cálculo o no he solicitado créditos.", score: 0 }
                        ]
                    },
                    {
                        id: "credito2", text: "¿Cómo manejas el pago de tu tarjeta de crédito?",
                        options: [
                            { text: "Siempre pago el total de mis consumos y actualmente tengo saldo en \"0\".", score: 3 },
                            { text: "Siempre pago el total de mis consumos y solo tengo saldo de compras a meses sin intereses.", score: 2 },
                            { text: "A veces \"No llego a la quincena\" y he tenido que pagar el mínimo.", score: 1 },
                            { text: "Casi siempre pago el mínimo / No tengo una tarjeta de crédito.", score: 0 }
                        ]
                    },
                    {
                        id: "credito3", text: "¿Para qué sueles utilizar los Meses Sin Intereses (MSI)?",
                        options: [
                            { text: "Solo para bienes duraderos o inversiones, como muebles o domiciliaciones de planes de inversión.", score: 3 },
                            { text: "Mayormente, aunque también para ropa, celulares u otros gastos diarios.", score: 2 },
                            { text: "Suelo comprar también mi despensa, vacaciones, restaurantes caros y servicios con MSI.", score: 1 },
                            { text: "Casi todo lo compro a \"MSI\" / No tengo tarjeta de crédito.", score: 0 }
                        ]
                    }
                ]
            },
            {
                title: "Inversión",
                fullTitle: "Inversión - Haciendo Crecer tu Patrimonio",
                subtitle: "Pon tu dinero a trabajar por ti. Evalúa tus estrategias de inversión y cómo puedes maximizar tus rendimientos.",
                questions: [
                    {
                        id: "inversion1", text: "Antes de invertir, ¿qué pasos sigues?",
                        options: [
                            { text: "Lo hice en acompañamiento de un profesional.", score: 3 },
                            { text: "Lo hice por mi propia cuenta.", score: 2 },
                            { text: "No lo hice, solo invertí porque los rendimientos eran atractivos.", score: 1 },
                            { text: "No he invertido.", score: 0 }
                        ]
                    },
                    {
                        id: "inversion2", text: "¿Qué entiendes por \"Meter los huevos en la misma canasta\"?",
                        options: [
                            { text: "Se trata de diversificar en inversiones que entiendas y puedas controlar el riesgo.", score: 3 },
                            { text: "Se trata de diversificar en cualquier inversión que te ofrezca un buen rendimiento.", score: 2 },
                            { text: "Se trata de tener tu estrategia de inversión en un solo activo para obtener mejores rendimientos a largo plazo.", score: 1 },
                            { text: "No lo conozco.", score: 0 }
                        ]
                    },
                    {
                        id: "inversion3", text: "¿Tienes una estrategia de inversión diversificada?",
                        options: [
                            { text: "Tengo una estrategia para mis metas de 1 a 3 años, 3 a 5 años y más de 5 años.", score: 3 },
                            { text: "Solamente hago mis estrategias para metas de 1 a 5 años.", score: 2 },
                            { text: "Solamente hago mis estrategias para metas de 1 a 3 años.", score: 1 },
                            { text: "No la tengo.", score: 0 }
                        ]
                    }
                ]
            },
            {
                title: "Retiro",
                fullTitle: "Retiro - Tu Futuro Seguro",
                subtitle: "Planifica hoy para disfrutar mañana. Analiza tu preparación para el retiro y cómo asegurar tu bienestar financiero a largo plazo.",
                questions: [
                    {
                        id: "retiro1", text: "¿Cómo estás planeando tu retiro?",
                        options: [
                            { text: "Tengo un plan de retiro diversificado con seguros, \"ppr\", negocio, afore, casas de bolsa, inmuebles, entre otros.", score: 3 },
                            { text: "Prefiero solo invertir en un negocio o bienes inmuebles.", score: 2 },
                            { text: "Solamente me jubilaré con mi afore/seguridad social.", score: 1 },
                            { text: "No pienso en mi retiro.", score: 0 }
                        ]
                    },
                    {
                        id: "retiro2", text: "¿Tienes una idea clara de cuánto dinero necesitarás para tu retiro?",
                        options: [
                            { text: "Lo sé y tengo un plan financiero para lograrlo.", score: 3 },
                            { text: "Lo sé pero aún no tengo un plan financiero para lograrlo.", score: 2 },
                            { text: "Solamente pienso retirarme con lo que reciba de mi afore/seguridad social.", score: 1 },
                            { text: "No tengo idea.", score: 0 }
                        ]
                    },
                    {
                        id: "retiro3", text: "¿Cuánto ahorras para tu retiro?",
                        options: [
                            { text: "Ahorro al menos el 10% de mis ingresos constantemente.", score: 3 },
                            { text: "Ahorro menos del 10% pero lo hago constantemente.", score: 2 },
                            { text: "Solo ahorro cuando me sobra algo de dinero.", score: 1 },
                            { text: "No ahorro para mi retiro o solo lo que cotizo en mi afore/seguridad social.", score: 0 }
                        ]
                    }
                ]
            },
            {
                title: "Seguros",
                fullTitle: "Seguros - Tu Red de Protección",
                subtitle: "Protege lo que más valoras. Evalúa tus coberturas de seguro y cómo salvaguardar tu futuro y el de tu familia.",
                questions: [
                    {
                        id: "seguros1", text: "¿Tienes un seguro de vida e invalidez?",
                        options: [
                            { text: "Sí lo tengo ya que me asesoré con un profesional.", score: 3 },
                            { text: "Tengo un seguro, pero no cubre 5 años de mis gastos mensuales.", score: 2 },
                            { text: "Solamente compré uno básico en el banco.", score: 1 },
                            { text: "No tengo ningún seguro de vida.", score: 0 }
                        ]
                    },
                    {
                        id: "seguros2", text: "¿Tienes un seguro de casa-habitación?",
                        options: [
                            { text: "Si lo tengo.", score: 3 },
                            { text: "No sabía que podía contratarlo aunque no sea dueño de la propiedad y pienso comprarlo.", score: 2 },
                            { text: "Tal vez en un futuro lo considere.", score: 1 },
                            { text: "No lo considero necesario.", score: 0 }
                        ]
                    },
                    {
                        id: "seguros3", text: "¿Cómo consideras un seguro?",
                        options: [
                            { text: "Totalmente de acuerdo, lo considero una inversión.", score: 3 },
                            { text: "Depende: si es un seguro de ahorro, es una inversión, pero si no es de ahorro, es un gasto.", score: 2 },
                            { text: "No lo había pensado.", score: 1 },
                            { text: "Definitivamente es un gasto.", score: 0 }
                        ]
                    }
                ]
            }
        ];
        const resultsLevels = [ 
            { min: 0, max: 20, title: "Rescate Financiero Urgente", comment: "Tu situación financiera requiere atención inmediata. Es crucial implementar cambios drásticos y buscar ayuda profesional para evitar graves consecuencias. Estás en un punto crítico donde las decisiones que tomes ahora impactarán tu futuro financiero.", recommendation: "Busca asesoría financiera profesional de inmediato. Cursos básicos de finanzas personales, crear presupuesto estricto y eliminar deudas de alto interés.", colorClass: "border-red-500 bg-red-50 text-red-700", barColor: "var(--color-level-1)" },
            { min: 21, max: 40, title: "Despertar Financiero", comment: "Estás empezando a tomar conciencia de la importancia de tus finanzas, pero aún hay mucho por mejorar. Es momento de adquirir conocimientos y herramientas para tomar el control de tu dinero. Tienes el potencial de mejorar, pero necesitas acción y compromiso.", recommendation: "Aprende sobre presupuestos, ahorro y manejo de deudas. Metas financieras pequeñas y realistas. Explora recursos en línea y talleres/seminarios sobre finanzas personales.", colorClass: "border-orange-500 bg-orange-50 text-orange-700", barColor: "var(--color-level-2)" },
            { min: 41, max: 60, title: "Camino a la Estabilidad", comment: "Has logrado avances significativos en tus finanzas, pero aún existen áreas de oportunidad. Estás construyendo una base sólida y, con algunos ajustes, puedes alcanzar una mayor estabilidad. Tus esfuerzos están dando frutos, pero la consistencia es clave.", recommendation: "Revisa y ajusta tu presupuesto regularmente. Inversiones a bajo riesgo y fondo de emergencia sólido. Diversifica ahorros y evalúa seguros.", colorClass: "border-yellow-500 bg-yellow-50 text-yellow-700", barColor: "var(--color-level-3)" },
            { min: 61, max: 80, title: "Potenciando tus Finanzas", comment: "Tienes un buen manejo de tus finanzas y estás en una posición sólida. Ahora es el momento de optimizar tus estrategias y buscar crecimiento financiero. Estás en una fase de crecimiento y refinamiento de tus habilidades financieras.", recommendation: "Inversiones más avanzadas y diversifica tu portafolio. Planifica para el retiro y evalúa tus seguros. Oportunidades para aumentar ingresos y mejorar planificación fiscal.", colorClass: "border-lime-500 bg-lime-50 text-lime-700", barColor: "var(--color-level-4)" }, 
            { min: 81, max: 100, title: "Maestro Financiero", comment: "Eres un experto en finanzas personales y estás en excelente forma. Tu enfoque disciplinado y estratégico te permitirá alcanzar tus metas financieras con éxito. Eres un modelo a seguir en cuanto a gestión financiera.", recommendation: "Continúa aprendiendo y adaptándote a los cambios del mercado. Mentorizar a otros y compartir tus conocimientos. Estrategias de inversión sofisticadas y planifica la transferencia de patrimonio.", colorClass: "border-green-500 bg-green-50 text-green-700", barColor: "var(--color-level-5)" }
        ];

        // --- DOM Elements ---
        const quizAppEl = document.getElementById('quizApp'); 
        const initialScreen = document.getElementById('initialScreen');
        const disclaimerScreenEl = document.getElementById('disclaimerScreen'); 
        const personalDataScreen = document.getElementById('personalDataScreen');
        const quizScreen = document.getElementById('quizScreen');
        const quizHeaderEl = document.getElementById('quizHeader'); 
        const patrimonialObjectiveInputScreenEl = document.getElementById('patrimonialObjectiveInputScreen'); 
        const loadingScreenEl = document.getElementById('loadingScreen'); 
        const resultsScreen = document.getElementById('resultsScreen');
        const moduleChartContainerEl = document.getElementById('moduleChartContainer');
        const finalPatrimonialResultsContainerEl = document.getElementById('finalPatrimonialResultsContainer');
        const overallPercentageBoxEl = document.getElementById('overallPercentageBox');
        const legendItemsContainerEl = document.getElementById('legendItemsContainer');
        const investorProfileQuestionContainerEl = document.getElementById('investorProfileQuestionContainer');
        const investorProfileErrorEl = document.getElementById('investorProfileError');
        const resultsScreenTitleEl = document.getElementById('resultsScreenTitle'); 


        const startQuizBtn = document.getElementById('startQuizBtn');
        const acceptDisclaimerBtnEl = document.getElementById('acceptDisclaimerBtn'); 
        const startMainQuizBtn = document.getElementById('startMainQuizBtn');
        const personalDataQuestionsContainer = document.getElementById('personalDataQuestionsContainer');
        const backBtnPersonalDataEl = document.getElementById('backBtnPersonalData'); 

        
        const sectionTitleEl = document.getElementById('sectionTitle');
        const sectionSubtitleEl = document.getElementById('sectionSubtitle');
        const allQuestionsContainerEl = document.getElementById('allQuestionsContainer'); 
        const nextSectionBtn = document.getElementById('nextSectionBtn'); 
        const backBtnQuiz = document.getElementById('backBtnQuiz'); 
        const backBtnPatrimonialInput = document.getElementById('backBtnPatrimonialInput'); 

        const selectionErrorEl = document.getElementById('selectionError');
        const progressBarEl = document.getElementById('progressBar');
        const sectionCounterEl = document.getElementById('sectionCounter'); 

        const currentAgeInput = document.getElementById('currentAge');
        const avgMonthlyIncomeInput = document.getElementById('avgMonthlyIncome');
        const generateReportBtnEl = document.getElementById('generateReportBtn'); 

        const scorePercentageEl = document.getElementById('scorePercentage');
        const resultsMessageContainerEl = document.getElementById('resultsMessageContainer');
        const resultsTitleEl = document.getElementById('resultsTitle');
        const resultsCommentEl = document.getElementById('resultsComment');
        const resultsRecommendationEl = document.getElementById('resultsRecommendation');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');

        // --- State Variables ---
        let currentPersonalData = {};
        let currentSectionIndex = 0;
        let userAnswers = {}; 
        let sectionScores = {}; 
        let totalAnsweredQuestions = 0; 
        let totalQuizQuestions = quizSections.reduce((acc, section) => acc + section.questions.length, 0);
        let patrimonialDataForDisplay = null; 
        let screenHistory = []; 
        let selectedInvestorProfileRate = 0.06; 

        // --- Functions ---
        function scrollToTop(element) {
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else { 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function showScreen(screenElement, cameFromBack = false) {
            const allScreens = [initialScreen, disclaimerScreenEl, personalDataScreen, quizScreen, patrimonialObjectiveInputScreenEl, loadingScreenEl, resultsScreen];
            allScreens.forEach(s => {
                if (s) s.classList.add('hidden');
            });
            if (screenElement) {
                screenElement.classList.remove('hidden');
                if (!cameFromBack) { 
                    scrollToTop(quizAppEl); 
                }
            }

            if (!cameFromBack && screenElement) {
                const currentScreenId = screenElement.id;
                if (screenElement.id !== resultsScreen.id && screenElement.id !== initialScreen.id && screenElement.id !== loadingScreenEl.id) { 
                     if (screenHistory[screenHistory.length -1] !== currentScreenId) {
                        screenHistory.push(currentScreenId);
                     }
                }
            }
        }
        
        function goBack() {
            if (screenHistory.length > 1) { 
                const currentScreenIdPopped = screenHistory.pop(); 
                const previousScreenId = screenHistory[screenHistory.length - 1]; 
                const previousScreenElement = document.getElementById(previousScreenId);

                if (previousScreenElement) {
                    if (currentScreenIdPopped === personalDataScreen.id && previousScreenId === disclaimerScreenEl.id) {
                        // No specific state reset needed here
                    } else if (currentScreenIdPopped === quizScreen.id && previousScreenId === personalDataScreen.id) {
                        currentSectionIndex = 0;
                        userAnswers = {};
                        sectionScores = {};
                        totalAnsweredQuestions = 0;
                        updateProgressBar(); 
                    } else if (currentScreenIdPopped === patrimonialObjectiveInputScreenEl.id && previousScreenId === quizScreen.id) {
                        currentSectionIndex = quizSections.length -1; 
                    }
                    showScreen(previousScreenElement, true); 
                    scrollToTop(quizAppEl); 
                }
            } else if (screenHistory.length === 1 && disclaimerScreenEl && screenHistory[0] === disclaimerScreenEl.id) { 
                screenHistory.pop();
                showScreen(initialScreen, true);
                scrollToTop(quizAppEl);
            }
        }

        function loadPersonalDataQuestions() {
            if (!personalDataQuestionsContainer) return;
            personalDataQuestionsContainer.innerHTML = ''; 
            const formFragment = document.createDocumentFragment();
            personalDataQuestions.forEach((pdQuestion) => { 
                const qDiv = document.createElement('div');
                qDiv.classList.add('mb-6');
                
                const qLabel = document.createElement('label'); 
                qLabel.classList.add('block', 'text-md', 'font-semibold', 'mb-1', 'text-gray-700');
                qLabel.style.fontFamily = 'var(--font-text)';
                qLabel.textContent = pdQuestion.question;
                if (pdQuestion.type === 'text') {
                    qLabel.htmlFor = pdQuestion.id;
                }
                qDiv.appendChild(qLabel);

                if (pdQuestion.type === 'text') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = pdQuestion.name;
                    input.id = pdQuestion.id;
                    input.placeholder = pdQuestion.placeholder || '';
                    input.classList.add('input-field', 'shadow-sm');
                    input.value = currentPersonalData[pdQuestion.id] || ''; 
                    input.addEventListener('input', (e) => { // Changed to input for real-time update
                        currentPersonalData[pdQuestion.id] = e.target.value.trim();
                    });
                    qDiv.appendChild(input);
                } else if (pdQuestion.type === 'radio') {
                    pdQuestion.options.forEach(optionText => {
                        const uniqueId = `${pdQuestion.name}_${optionText.replace(/\s+/g, '_').replace(/[¿?"'.!,]/g, '')}`;
                        const optionWrapper = document.createElement('label');
                        optionWrapper.classList.add('option-label');
                        optionWrapper.htmlFor = uniqueId;

                        const radio = document.createElement('input');
                        radio.type = pdQuestion.type;
                        radio.name = pdQuestion.name; 
                        radio.value = optionText;
                        radio.required = true;
                        radio.id = uniqueId;
                        radio.classList.add('mr-3'); 

                        if (currentPersonalData[pdQuestion.id] === optionText) {
                            radio.checked = true;
                            optionWrapper.classList.add('selected');
                        }

                        optionWrapper.appendChild(radio);
                        optionWrapper.appendChild(document.createTextNode(optionText));
                        qDiv.appendChild(optionWrapper);

                        radio.addEventListener('change', () => {
                            document.querySelectorAll(`input[name="${pdQuestion.name}"]`).forEach(r => {
                                if(r.parentElement) r.parentElement.classList.remove('selected');
                            });
                            if (radio.checked) {
                                if(optionWrapper) optionWrapper.classList.add('selected');
                                currentPersonalData[pdQuestion.id] = radio.value; 
                            }
                        });
                    });
                }
                formFragment.appendChild(qDiv);
            });
            personalDataQuestionsContainer.appendChild(formFragment);
        }
        
        function loadInvestorProfileQuestion() {
            if (!investorProfileQuestionContainerEl) return;
            investorProfileQuestionContainerEl.innerHTML = '';
            const q = investorProfileQuestion;

            const qLabel = document.createElement('p');
            qLabel.classList.add('text-md', 'font-semibold', 'text-gray-700', 'mb-3');
            qLabel.style.fontFamily = 'var(--font-text)';
            qLabel.textContent = q.question;
            investorProfileQuestionContainerEl.appendChild(qLabel);

            q.options.forEach(option => {
                const uniqueId = `${q.id}_${option.rate}`;
                const optionWrapper = document.createElement('label');
                optionWrapper.classList.add('option-label');
                optionWrapper.htmlFor = uniqueId;

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = q.id;
                radio.value = option.rate; 
                radio.id = uniqueId;
                radio.dataset.profileName = option.profileName; 

                optionWrapper.appendChild(radio);
                optionWrapper.appendChild(document.createTextNode(option.text));
                investorProfileQuestionContainerEl.appendChild(optionWrapper);

                radio.addEventListener('change', () => {
                    document.querySelectorAll(`input[name="${q.id}"]`).forEach(r => {
                        if(r.parentElement) r.parentElement.classList.remove('selected');
                    });
                    if (radio.checked) {
                        optionWrapper.classList.add('selected');
                        selectedInvestorProfileRate = parseFloat(radio.value);
                        if(investorProfileErrorEl) investorProfileErrorEl.classList.add('hidden');
                    }
                });
            });
        }


        function updateProgressBar() {
            let answeredQuizCount = 0;
            quizSections.forEach(section => {
                section.questions.forEach(question => {
                    if (userAnswers[question.id] !== undefined) {
                        answeredQuizCount++;
                    }
                });
            });
            totalAnsweredQuestions = answeredQuizCount; 

            const progress = totalQuizQuestions > 0 ? (totalAnsweredQuestions / totalQuizQuestions) * 100 : 0;
            if(progressBarEl) progressBarEl.style.width = `${progress}%`;
        }

        function loadSection() {
            if(selectionErrorEl) selectionErrorEl.classList.add('hidden');
            const section = quizSections[currentSectionIndex];

            if(sectionTitleEl) sectionTitleEl.textContent = section.fullTitle; 
            if(sectionSubtitleEl) sectionSubtitleEl.textContent = section.subtitle;
            if(sectionCounterEl) sectionCounterEl.textContent = `Sección ${currentSectionIndex + 1} de ${quizSections.length}`;
            
            if(nextSectionBtn) {
                if (currentSectionIndex === quizSections.length - 1) {
                    nextSectionBtn.textContent = "Siguiente"; 
                } else {
                    nextSectionBtn.textContent = "Siguiente Sección";
                }
            }

            if(allQuestionsContainerEl) allQuestionsContainerEl.innerHTML = ''; 
            
            section.questions.forEach(question => {
                const questionBlock = document.createElement('div');
                questionBlock.classList.add('question-block'); 

                const questionTextP = document.createElement('p');
                questionTextP.classList.add('text-lg', 'font-semibold', 'mb-4'); 
                questionTextP.style.fontFamily = 'var(--font-text)';
                questionTextP.style.color = '#333';
                questionTextP.textContent = question.text;
                questionBlock.appendChild(questionTextP);

                const optionsDiv = document.createElement('div');
                question.options.forEach(option => {
                    const uniqueId = `${question.id}_${option.score}_${currentSectionIndex}`; 
                    const label = document.createElement('label');
                    label.classList.add('option-label');
                    label.htmlFor = uniqueId;

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = question.id; 
                    radio.value = option.score;
                    radio.id = uniqueId;
                    
                    if (userAnswers[question.id] !== undefined && userAnswers[question.id] === option.score) {
                        radio.checked = true;
                        label.classList.add('selected');
                    }

                    label.appendChild(radio);
                    label.appendChild(document.createTextNode(" " + option.text));
                    optionsDiv.appendChild(label);

                    radio.addEventListener('change', () => {
                        document.querySelectorAll(`input[name="${question.id}"]`).forEach(r => {
                           if(r.parentElement) r.parentElement.classList.remove('selected');
                        });
                        if (radio.checked) {
                            if(label) label.classList.add('selected');
                            userAnswers[question.id] = parseInt(radio.value); 
                        }
                        updateProgressBar(); 
                    });
                });
                questionBlock.appendChild(optionsDiv);
                if(allQuestionsContainerEl) allQuestionsContainerEl.appendChild(questionBlock);
            });
            
            updateProgressBar(); 
            scrollToTop(quizHeaderEl); 

            if (backBtnQuiz) {
                if (currentSectionIndex === 0) {
                    backBtnQuiz.classList.add('opacity-50', 'pointer-events-none'); 
                } else {
                    backBtnQuiz.classList.remove('opacity-50', 'pointer-events-none');
                }
            }
        }
        
        function calculateAndStoreSectionScores() {
            sectionScores = {}; 
            quizSections.forEach(section => {
                let currentSectionScore = 0;
                let questionsInSection = section.questions.length;
                if (questionsInSection === 0) {
                    sectionScores[section.title] = 0; 
                    return;
                }
                section.questions.forEach(question => {
                    if (userAnswers[question.id] !== undefined) {
                        currentSectionScore += userAnswers[question.id];
                    }
                });
                const maxSectionScore = questionsInSection * 3; 
                const percentage = maxSectionScore > 0 ? (currentSectionScore / maxSectionScore) * 100 : 0;
                sectionScores[section.title] = percentage;
            });
        }


        function handleNextSection() {
            const section = quizSections[currentSectionIndex];
            let allAnsweredInSection = true;
            
            for (const question of section.questions) {
                if (userAnswers[question.id] === undefined) { 
                    allAnsweredInSection = false;
                    break;
                }
            }

            if (!allAnsweredInSection) {
                if(selectionErrorEl) selectionErrorEl.classList.remove('hidden');
                return;
            }
            if(selectionErrorEl) selectionErrorEl.classList.add('hidden');
            
            currentSectionIndex++;
            if (currentSectionIndex < quizSections.length) {
                loadSection(); 
            } else {
                calculateAndStoreSectionScores(); 
                loadInvestorProfileQuestion(); 
                showScreen(patrimonialObjectiveInputScreenEl); 
            }
        }

        function handleBackSection() {
            if (currentSectionIndex > 0) {
                currentSectionIndex--;
                loadSection(); 
            } else {
                goBack(); 
            }
        }
        
        function calculatePatrimonialObjectiveData() { 
            const age = parseFloat(currentAgeInput ? currentAgeInput.value : 0);
            const income = parseFloat(avgMonthlyIncomeInput ? avgMonthlyIncomeInput.value : 0);
            patrimonialDataForDisplay = null; 

            if (isNaN(age) || age < 18 || age > 70) { 
                patrimonialDataForDisplay = { calculatedSuccessfully: false, message: "Por favor, ingresa una edad válida entre 18 y 70 años."};
                alert(patrimonialDataForDisplay.message); 
                return false;
            }
            if (isNaN(income) || income <= 0) {
                patrimonialDataForDisplay = { calculatedSuccessfully: false, message: "Por favor, ingresa un ingreso mensual válido."};
                 alert(patrimonialDataForDisplay.message); 
                return false; 
            }
             if (age <= 26.5) { 
                patrimonialDataForDisplay = { calculatedSuccessfully: false, message: "La edad debe ser mayor a 26.5 para esta fórmula particular."};
                alert(patrimonialDataForDisplay.message); 
                return false; 
            }

            const yearsContribution = age - 26.5;
            const patrimonialObjective = yearsContribution * 2.65 * income;
            
            const yearsContributionDisplay = Math.round(yearsContribution); 


            const objectiveText = `Tu patrimonio mínimo recomendado es: $${patrimonialObjective.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} MXN.`; 
            let pureSavingsText = "";
            let investmentSavingsText = "";

            if (yearsContribution > 0) {
                const annualSavingsNeededPure = patrimonialObjective / yearsContribution;
                const percentageSavingsPure = (annualSavingsNeededPure / (income * 12)) * 100;
                pureSavingsText = `Para alcanzar este objetivo, si solo hubieras ahorrado (sin invertir), tendrías que haber ahorrado aproximadamente ${percentageSavingsPure.toFixed(0)}% de tus ingresos anuales durante los últimos ${yearsContributionDisplay} años.`; 

                const r = selectedInvestorProfileRate; 
                const n = yearsContribution;
                const fvAnnuityFactor = ((Math.pow(1 + r, n) - 1) / r);
                
                if (fvAnnuityFactor > 0) {
                    const annualSavingsNeededInvestment = patrimonialObjective / fvAnnuityFactor;
                    const percentageSavingsInvestment = (annualSavingsNeededInvestment / (income * 12)) * 100;
                    investmentSavingsText = `Sin embargo, si hubieras invertido ese dinero en un instrumento con un rendimiento promedio del ${(r * 100).toFixed(0)}% anual, solo necesitarías haber ahorrado aproximadamente ${percentageSavingsInvestment.toFixed(0)}% de tus ingresos anuales para alcanzar la misma meta. ¡La inversión puede hacer una gran diferencia!`; 
                } else {
                     investmentSavingsText = "No se pudo calcular el ahorro con inversión para los parámetros dados.";
                }
            } else {
                 pureSavingsText = "No se puede calcular el análisis de ahorro para una edad menor o igual a 26.5 años con esta fórmula.";
            }
            
            patrimonialDataForDisplay = { 
                ageUsed: age,
                incomeUsed: income,
                interestRateUsed: selectedInvestorProfileRate,
                objective: objectiveText,
                pureSavings: pureSavingsText,
                investmentSavings: investmentSavingsText,
                calculatedSuccessfully: true
            };
            return true; 
        }
        
        function getBarColorForPercentage(percentage) {
            if (percentage <= 20) return resultsLevels[0].barColor; 
            if (percentage <= 40) return resultsLevels[1].barColor; 
            if (percentage <= 60) return resultsLevels[2].barColor; 
            if (percentage <= 80) return resultsLevels[3].barColor; 
            return resultsLevels[4].barColor; 
        }
        
        function populateResultsLegend() {
            if (!legendItemsContainerEl) return;
            legendItemsContainerEl.innerHTML = ''; 

            resultsLevels.forEach(level => {
                const legendItemDiv = document.createElement('div');
                legendItemDiv.classList.add('results-legend-item');

                const colorSwatch = document.createElement('div');
                colorSwatch.classList.add('legend-color-swatch');
                colorSwatch.style.backgroundColor = level.barColor;
                legendItemDiv.appendChild(colorSwatch);

                const levelText = document.createElement('span');
                levelText.textContent = `${level.title} (${level.min}% - ${level.max}%)`;
                legendItemDiv.appendChild(levelText);

                legendItemsContainerEl.appendChild(legendItemDiv);
            });
        }

        function displayMotivationalText(type, ctaButtonsDiv) {
            const existingMotivationalText = finalPatrimonialResultsContainerEl.querySelector('.motivational-text');
            if (existingMotivationalText) {
                existingMotivationalText.remove();
            }
             
            ctaButtonsDiv.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains('btn-cta-achieved')) {
                    btn.style.backgroundColor = 'var(--color-cta-achieved-bg)';
                    btn.style.color = 'var(--color-cta-achieved-text)';
                    btn.style.borderColor = 'var(--color-cta-achieved-border)';
                } else if (btn.classList.contains('btn-cta-not-achieved')) {
                     btn.style.backgroundColor = 'var(--color-cta-not-achieved-bg)';
                     btn.style.color = 'var(--color-cta-not-achieved-text)';
                     btn.style.borderColor = 'var(--color-cta-not-achieved-border)';
                }
            });


            const textDiv = document.createElement('div');
            textDiv.classList.add('motivational-text');
            if (type === 'achieved') {
                textDiv.innerHTML = `
                    <p class="font-semibold mb-2">¡Felicidades por alcanzar tu objetivo patrimonial!</p>
                    <p>Este es un gran logro y demuestra tu disciplina financiera. Ahora es el momento de asegurar que tu patrimonio siga creciendo y trabajando para ti. Podemos ayudarte a explorar estrategias de inversión avanzadas, optimización fiscal y planificación de legado para maximizar tus rendimientos y proteger lo que has construido.</p>
                    <p class="mt-3"><strong>¿Listo para el siguiente nivel?</strong> <a href="#" class="font-bold underline hover:text-indigo-700">Contáctanos para una asesoría personalizada.</a></p>
                `;
                const achievedButton = ctaButtonsDiv.querySelector('.btn-cta-achieved');
                if (achievedButton) {
                    achievedButton.classList.add('active');
                    achievedButton.style.backgroundColor = 'var(--color-cta-achieved-active-bg)';
                    achievedButton.style.color = 'var(--color-cta-achieved-active-text)';
                    achievedButton.style.borderColor = 'var(--color-cta-achieved-active-bg)';
                }


            } else if (type === 'notAchieved') {
                textDiv.innerHTML = `
                    <p class="font-semibold mb-2">¡No te desanimes! Estás en el camino correcto al buscar mejorar.</p>
                    <p>Alcanzar tu objetivo patrimonial es un viaje, y cada paso cuenta. Identificar dónde te encuentras es el primer gran paso. Podemos ayudarte a crear un plan de ahorro e inversión personalizado, optimizar tu presupuesto y establecer estrategias claras para que alcances tus metas financieras más rápido de lo que imaginas.</p>
                    <p class="mt-3"><strong>¿Listo para tomar el control y construir tu futuro?</strong> <a href="#" class="font-bold underline hover:text-indigo-700">Hablemos sobre cómo podemos ayudarte.</a></p>
                `;
                const notAchievedButton = ctaButtonsDiv.querySelector('.btn-cta-not-achieved');
                if (notAchievedButton) {
                    notAchievedButton.classList.add('active');
                    notAchievedButton.style.backgroundColor = 'var(--color-cta-not-achieved-active-bg)';
                    notAchievedButton.style.color = 'var(--color-cta-not-achieved-active-text)';
                    notAchievedButton.style.borderColor = 'var(--color-cta-not-achieved-active-bg)';
                }
            }
            ctaButtonsDiv.parentNode.insertBefore(textDiv, ctaButtonsDiv.nextSibling);
            scrollToTop(textDiv); 
        }


        function showResults() {
            if (!moduleChartContainerEl || !finalPatrimonialResultsContainerEl) return;
            moduleChartContainerEl.innerHTML = ''; 
            finalPatrimonialResultsContainerEl.innerHTML = ''; 

            const userName = currentPersonalData.nombre || "Usuario"; 
            if(resultsScreenTitleEl) resultsScreenTitleEl.textContent = `¡Tus Resultados Están Aquí, ${userName}!`;


            let finalOverallScore = 0;
            for (const questionId in userAnswers) {
                if (userAnswers.hasOwnProperty(questionId)) {
                    let isQuizQ = false;
                    for(const section of quizSections) {
                        if (section.questions.find(q => q.id === questionId)) {
                            isQuizQ = true;
                            break;
                        }
                    }
                    if(isQuizQ) {
                        finalOverallScore += userAnswers[questionId];
                    }
                }
            }
            const maxOverallScore = totalQuizQuestions * 3; 
            const overallPercentage = maxOverallScore > 0 ? (finalOverallScore / maxOverallScore) * 100 : 0;

            if(scorePercentageEl) scorePercentageEl.textContent = `${overallPercentage.toFixed(0)}%`;
            
            const overallLevelColor = getBarColorForPercentage(overallPercentage);
            if (overallPercentageBoxEl) {
                overallPercentageBoxEl.style.backgroundColor = overallLevelColor;
            }

            quizSections.forEach(section => {
                const percentage = sectionScores[section.title] !== undefined ? sectionScores[section.title] : 0;
                const barColor = getBarColorForPercentage(percentage);
                
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('bar-chart-item');

                const labelSpan = document.createElement('span');
                labelSpan.classList.add('bar-chart-label');
                labelSpan.textContent = section.title; 
                itemDiv.appendChild(labelSpan);

                const barContainerDiv = document.createElement('div');
                barContainerDiv.classList.add('bar-container');
                
                const barFillDiv = document.createElement('div');
                barFillDiv.classList.add('bar-fill');
                barFillDiv.style.width = `${percentage.toFixed(0)}%`;
                barFillDiv.style.backgroundColor = barColor; 
                
                const percentageTextSpan = document.createElement('span');
                percentageTextSpan.classList.add('bar-percentage-text');
                percentageTextSpan.textContent = `${percentage.toFixed(0)}%`;
                barFillDiv.appendChild(percentageTextSpan);

                barContainerDiv.appendChild(barFillDiv);
                itemDiv.appendChild(barContainerDiv);
                moduleChartContainerEl.appendChild(itemDiv);
            });

            const resultLevel = resultsLevels.find(level => overallPercentage >= level.min && overallPercentage <= level.max);
            if (resultLevel) {
                if(resultsTitleEl) resultsTitleEl.textContent = resultLevel.title;
                if(resultsCommentEl) resultsCommentEl.textContent = resultLevel.comment;
                if(resultsRecommendationEl) resultsRecommendationEl.textContent = `Recomendación: ${resultLevel.recommendation}`;
                if(resultsMessageContainerEl) { 
                    resultsMessageContainerEl.className = `results-message-container p-4 ${resultLevel.colorClass.replace(/border-\w+-\d+/, '').replace(/bg-\w+-\d+/, 'bg-opacity-10')} border-l-4 ${resultLevel.colorClass.match(/border-\w+-\d+/)[0]}`;
                }
            }

            if (patrimonialDataForDisplay && patrimonialDataForDisplay.calculatedSuccessfully) {
                const patrimonialTitle = document.createElement('h3');
                patrimonialTitle.textContent = "Análisis de Objetivo Patrimonial";
                finalPatrimonialResultsContainerEl.appendChild(patrimonialTitle);

                const numeroMagicoP = document.createElement('p');
                numeroMagicoP.classList.add('numero-magico');
                numeroMagicoP.textContent = patrimonialDataForDisplay.objective.split(': $')[1]; 
                finalPatrimonialResultsContainerEl.appendChild(numeroMagicoP);

                const numeroMagicoLabelP = document.createElement('p');
                numeroMagicoLabelP.classList.add('numero-magico-label');
                numeroMagicoLabelP.textContent = "Tu patrimonio mínimo recomendado es:";
                finalPatrimonialResultsContainerEl.insertBefore(numeroMagicoLabelP, numeroMagicoP); 
                
                const objectiveIntroP = document.createElement('p');
                objectiveIntroP.innerHTML = `Basado en una edad de <strong>${patrimonialDataForDisplay.ageUsed} años</strong>, un ingreso mensual promedio de <strong>$${patrimonialDataForDisplay.incomeUsed.toLocaleString('es-MX', {minimumFractionDigits: 0, maximumFractionDigits: 0})} MXN</strong> y una tasa de inversión del <strong>${(patrimonialDataForDisplay.interestRateUsed * 100).toFixed(0)}% anual</strong>:`;
                finalPatrimonialResultsContainerEl.appendChild(objectiveIntroP);


                const pureSavingsP = document.createElement('p');
                pureSavingsP.textContent = patrimonialDataForDisplay.pureSavings;
                finalPatrimonialResultsContainerEl.appendChild(pureSavingsP);

                const investmentSavingsP = document.createElement('p');
                investmentSavingsP.textContent = patrimonialDataForDisplay.investmentSavings;
                finalPatrimonialResultsContainerEl.appendChild(investmentSavingsP);
                
                const noteP = document.createElement('p');
                noteP.classList.add('text-xs', 'mt-4');
                noteP.innerHTML = "<strong>Nota:</strong> Este es un estimado basado en la fórmula proporcionada. Para una planificación más detallada, te recomendamos hablar con un asesor financiero.";
                finalPatrimonialResultsContainerEl.appendChild(noteP);

                const ctaButtonsDiv = document.createElement('div');
                ctaButtonsDiv.classList.add('patrimonial-cta-buttons');
                
                const achievedBtn = document.createElement('button');
                achievedBtn.classList.add('btn', 'btn-cta-achieved', 'flex-1'); 
                achievedBtn.innerHTML = '¡Ya he logrado ese objetivo! &#x1F60A;'; 
                achievedBtn.addEventListener('click', () => displayMotivationalText('achieved', ctaButtonsDiv));
                ctaButtonsDiv.appendChild(achievedBtn);

                const notAchievedBtn = document.createElement('button');
                notAchievedBtn.classList.add('btn', 'btn-cta-not-achieved', 'flex-1');
                notAchievedBtn.innerHTML = '¡Aún no lo logro! &#x1F622;'; 
                notAchievedBtn.addEventListener('click', () => displayMotivationalText('notAchieved', ctaButtonsDiv));
                ctaButtonsDiv.appendChild(notAchievedBtn);
                
                finalPatrimonialResultsContainerEl.appendChild(ctaButtonsDiv);


            } else if (patrimonialDataForDisplay && !patrimonialDataForDisplay.calculatedSuccessfully) {
                 const errorMessageP = document.createElement('p');
                 errorMessageP.textContent = patrimonialDataForDisplay.message || "No se pudo calcular el objetivo patrimonial. Verifica los datos ingresados.";
                 errorMessageP.classList.add('text-sm', 'text-red-600', 'text-center', 'p-4', 'border', 'border-red-300', 'bg-red-50', 'rounded-md');
                 finalPatrimonialResultsContainerEl.appendChild(errorMessageP);
            } else {
                 const noCalcMessage = document.createElement('p');
                 noCalcMessage.textContent = "No se ingresaron datos para el cálculo del objetivo patrimonial.";
                 noCalcMessage.classList.add('text-sm', 'text-gray-600', 'text-center', 'p-4');
                 finalPatrimonialResultsContainerEl.appendChild(noCalcMessage);
            }
            
            populateResultsLegend(); 
            showScreen(resultsScreen); 
        }
        
        function collectPersonalData() {
            let allAnswered = true;
            let missingFieldName = "";

            personalDataQuestions.forEach(pdQuestion => { 
                if (pdQuestion.type === 'text') {
                    const inputEl = document.getElementById(pdQuestion.id);
                    if (inputEl && inputEl.value.trim() === '' && pdQuestion.id !== 'nombre') { 
                       allAnswered = false; 
                       if (!missingFieldName) missingFieldName = pdQuestion.question;
                    } else if (inputEl) {
                         currentPersonalData[pdQuestion.id] = inputEl.value.trim();
                    }
                } else if (pdQuestion.type === 'radio') {
                    if (currentPersonalData[pdQuestion.id] === undefined) {
                        allAnswered = false;
                        if (!missingFieldName) missingFieldName = pdQuestion.question;
                    }
                }
            });
            if (!allAnswered && missingFieldName) {
                 alert(`Por favor, responde la pregunta: "${missingFieldName}"`);
            } else if (!allAnswered) {
                 alert("Por favor, responde todas las preguntas de datos personales, excepto el nombre que es opcional.");
            }
            return allAnswered;
        }

        function downloadResultsPDF() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                alert("Error: La biblioteca para generar PDF no está cargada. No se puede descargar el PDF.");
                console.error("jsPDF library is not loaded.");
                return;
            }
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF();
            let yPos = 20;
            const lineSpacing = 7;
            const sectionSpacing = 10;
            const indent = 10;
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            const maxLineWidth = pageWidth - margin * 2;
            
            const titleFont = 'Helvetica'; 
            const textFont = 'Helvetica'; 

            doc.setFont(titleFont, 'bold'); 
            doc.setFontSize(18);
            const userNameForPDF = currentPersonalData.nombre ? `, ${currentPersonalData.nombre}` : "";
            doc.text(`Resultados del Test de Finanzas Personales${userNameForPDF}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += sectionSpacing * 1.5;

            doc.setFont(titleFont, 'bold'); 
            doc.setFontSize(14);
            doc.text("Datos Personales:", margin, yPos);
            yPos += lineSpacing;
            doc.setFont(textFont, 'normal'); 
            doc.setFontSize(10);
            personalDataQuestions.forEach(pd => { 
                if (currentPersonalData[pd.id]) {
                    const text = `${pd.question}: ${currentPersonalData[pd.id]}`;
                    const splitText = doc.splitTextToSize(text, maxLineWidth - indent);
                    doc.text(splitText, margin + indent, yPos);
                    yPos += splitText.length * (lineSpacing * 0.7) + 2;
                }
            });
            yPos += sectionSpacing;

            doc.setFont(titleFont, 'bold');
            doc.setFontSize(14);
            doc.text("Resultados Generales del Test:", margin, yPos); 
            yPos += lineSpacing;
            doc.setFont(textFont, 'normal');
            doc.setFontSize(12);
            if (scorePercentageEl) { 
                 doc.text(`Resultado General: ${scorePercentageEl.textContent}`, margin + indent, yPos);
            }
            yPos += lineSpacing;

            doc.setFont(titleFont, 'bold');
            doc.setFontSize(11);
            if (resultsTitleEl) doc.text(`Nivel Financiero: ${resultsTitleEl.textContent}`, margin + indent, yPos);
            yPos += lineSpacing;
            
            doc.setFont(textFont, 'normal');
            if (resultsCommentEl) {
                const commentText = doc.splitTextToSize(`Comentario: ${resultsCommentEl.textContent}`, maxLineWidth - indent);
                doc.text(commentText, margin + indent, yPos);
                yPos += commentText.length * (lineSpacing * 0.7) + 2;
            }
            
            doc.setFont(textFont, 'bold');
            if (resultsRecommendationEl) {
                const recommendationTextContent = resultsRecommendationEl.textContent.startsWith("Recomendación: ") ? resultsRecommendationEl.textContent : `Recomendación: ${resultsRecommendationEl.textContent}`;
                const recommendationText = doc.splitTextToSize(recommendationTextContent, maxLineWidth - indent);
                doc.text(recommendationText, margin + indent, yPos);
                yPos += recommendationText.length * (lineSpacing * 0.7) + sectionSpacing;
            }

            doc.setFont(titleFont, 'bold');
            doc.setFontSize(14);
            doc.text("Resultados por Módulo:", margin, yPos);
            yPos += lineSpacing;
            doc.setFont(textFont, 'normal');
            doc.setFontSize(10);
            quizSections.forEach(section => {
                const percentage = sectionScores[section.title] !== undefined ? sectionScores[section.title] : 0;
                const text = `${section.title}: ${percentage.toFixed(0)}%`;
                doc.text(text, margin + indent, yPos);
                yPos += lineSpacing * 0.9;
            });
            yPos += sectionSpacing;


            if (patrimonialDataForDisplay && patrimonialDataForDisplay.calculatedSuccessfully) { 
                doc.setFont(titleFont, 'bold');
                doc.setFontSize(14);
                doc.text("Análisis de Objetivo Patrimonial:", margin, yPos); 
                yPos += lineSpacing;
                doc.setFont(textFont, 'normal');
                doc.setFontSize(10);

                const ageIncomeText = `Para una edad de ${patrimonialDataForDisplay.ageUsed} años, un ingreso mensual de $${patrimonialDataForDisplay.incomeUsed.toLocaleString('es-MX', {minimumFractionDigits: 0, maximumFractionDigits: 0})} MXN y una tasa de inversión del ${(patrimonialDataForDisplay.interestRateUsed * 100).toFixed(0)}%:`;
                const splitAgeIncome = doc.splitTextToSize(ageIncomeText, maxLineWidth - indent);
                doc.text(splitAgeIncome, margin + indent, yPos);
                yPos += splitAgeIncome.length * (lineSpacing * 0.7) +2;

                const objectivePDFText = doc.splitTextToSize(patrimonialDataForDisplay.objective, maxLineWidth - indent);
                doc.text(objectivePDFText, margin + indent, yPos);
                yPos += objectivePDFText.length * (lineSpacing * 0.7) + 2;
                
                if (patrimonialDataForDisplay.pureSavings) {
                    const pureSavingsPDFText = doc.splitTextToSize(patrimonialDataForDisplay.pureSavings, maxLineWidth - indent);
                    doc.text(pureSavingsPDFText, margin + indent, yPos);
                    yPos += pureSavingsPDFText.length * (lineSpacing * 0.7) + 2;
                }
                if (patrimonialDataForDisplay.investmentSavings) {
                    const investmentSavingsPDFText = doc.splitTextToSize(patrimonialDataForDisplay.investmentSavings, maxLineWidth - indent);
                    doc.text(investmentSavingsPDFText, margin + indent, yPos);
                    yPos += investmentSavingsPDFText.length * (lineSpacing * 0.7) + 2;
                }
                yPos += lineSpacing;
                doc.setFontSize(8);
                doc.text("Nota: El cálculo patrimonial es una estimación referencial.", margin + indent, yPos);
            }
            doc.save("Resultados_Test_Finanzas_Personales.pdf");
        }

        // --- Event Listeners ---
        if(startQuizBtn) startQuizBtn.addEventListener('click', () => {
            if(initialScreen) screenHistory = [initialScreen.id]; 
            showScreen(disclaimerScreenEl); 
        });
        
        if(acceptDisclaimerBtnEl) acceptDisclaimerBtnEl.addEventListener('click', () => {
            currentPersonalData = {}; 
            loadPersonalDataQuestions();
            showScreen(personalDataScreen);
        });

        if(backBtnPersonalDataEl) backBtnPersonalDataEl.addEventListener('click', () => {
            goBack(); 
        });


        if(startMainQuizBtn) startMainQuizBtn.addEventListener('click', () => {
            if (collectPersonalData()) {
                currentSectionIndex = 0;
                userAnswers = {}; 
                sectionScores = {}; 
                totalAnsweredQuestions = 0; 
                patrimonialDataForDisplay = null; 
                loadSection(); 
                showScreen(quizScreen);
            } 
        });

        if(nextSectionBtn) nextSectionBtn.addEventListener('click', handleNextSection); 
        if(backBtnQuiz) backBtnQuiz.addEventListener('click', handleBackSection); 
        
        if(backBtnPatrimonialInput) backBtnPatrimonialInput.addEventListener('click', () => { 
             goBack(); 
        });

        if(generateReportBtnEl) generateReportBtnEl.addEventListener('click', () => { 
            const investorProfileSelected = investorProfileQuestionContainerEl.querySelector(`input[name="${investorProfileQuestion.id}"]:checked`);
            if (!investorProfileSelected) {
                if(investorProfileErrorEl) investorProfileErrorEl.classList.remove('hidden');
                alert("Por favor, selecciona tu perfil de inversionista.");
                return;
            }
            if(investorProfileErrorEl) investorProfileErrorEl.classList.add('hidden');
            
            if (!calculatePatrimonialObjectiveData()) { 
                return; 
            }
            
            showScreen(loadingScreenEl);
            setTimeout(() => {
                if (Object.keys(sectionScores).length === 0) { 
                   calculateAndStoreSectionScores(); 
                }
                showResults();
            }, quizConfig.loadingDelay);
        });
        
        if(downloadPdfBtn) downloadPdfBtn.addEventListener('click', downloadResultsPDF);

        if(restartQuizBtn) restartQuizBtn.addEventListener('click', () => {
            currentPersonalData = {};
            currentSectionIndex = 0;
            userAnswers = {};
            sectionScores = {};
            totalAnsweredQuestions = 0;
            patrimonialDataForDisplay = null; 
            if(progressBarEl) progressBarEl.style.width = '0%';
            if(currentAgeInput) currentAgeInput.value = '';
            if(avgMonthlyIncomeInput) avgMonthlyIncomeInput.value = '';
            selectedInvestorProfileRate = 0.06; 
            screenHistory = []; 
            showScreen(initialScreen);
        });

        // --- Initial Load ---
        showScreen(initialScreen);

    </script>
</body>
</html>
