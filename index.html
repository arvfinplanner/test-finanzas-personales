<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Finanzas Personales Sanas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@700;900&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --color-primary: #863399; /* Purple */
            --color-secondary: #E7004C; /* Pink/Magenta */
            --font-title: 'League Spartan', sans-serif;
            --font-text: 'Montserrat', sans-serif;

            /* Dynamic result colors */
            --color-level-1: #EF4444; /* red-500 (Rescate) */
            --color-level-2: #F97316; /* orange-500 (Despertar) */
            --color-level-3: #EAB308; /* yellow-500 (Camino) */
            --color-level-4: #84CC16; /* lime-500 (Potenciando) */
            --color-level-5: #22C55E; /* green-500 (Maestro) */

            /* CTA Button Colors */
            --color-cta-achieved-bg: #D1FAE5; /* green-100 */
            --color-cta-achieved-text: #065F46; /* green-800 */
            --color-cta-achieved-border: #6EE7B7; /* green-300 */
            --color-cta-achieved-hover-bg: #A7F3D0; /* green-200 */
            --color-cta-achieved-active-bg: #10B981; /* green-500 */
            --color-cta-achieved-active-text: white;

            --color-cta-not-achieved-bg: #FEE2E2; /* red-100 */
            --color-cta-not-achieved-text: #991B1B; /* red-800 */
            --color-cta-not-achieved-border: #FCA5A5; /* red-300 */
            --color-cta-not-achieved-hover-bg: #FECACA; /* red-200 */
            --color-cta-not-achieved-active-bg: #EF4444; /* red-500 */
            --color-cta-not-achieved-active-text: white;
        }

        html {
            scroll-behavior: smooth; 
        }

        body {
            font-family: var(--font-text);
            background-color: #ffffff;
            color: #333;
            min-height: 100vh; 
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-title);
            color: var(--color-primary);
            font-weight: 700; 
        }
        .font-league-spartan-black {
            font-family: var(--font-title);
            font-weight: 900; 
        }

        .quiz-container {
            max-width: 900px; 
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .question-section-layout {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 1.5rem; 
        }
        @media (min-width: 768px) { 
            .question-section-layout {
                grid-template-columns: 1fr 2fr; 
            }
        }
        .section-info-column h2 {
            font-size: 1.75rem; 
            margin-bottom: 0.5rem;
        }
        .section-info-column p {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.6;
        }

        .question-block { 
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #f8fafc;
        }
        .option-label {
            display: block;
            padding: 0.85rem 1.25rem;
            margin-bottom: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            background-color: white;
            font-family: var(--font-text);
            font-size: 0.95rem;
        }
        .option-label:hover {
            border-color: var(--color-primary);
        }
        .option-label.selected {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        .option-label input[type="radio"] {
            margin-right: 0.75rem;
            accent-color: var(--color-secondary); 
        }
        .option-label.selected input[type="radio"] {
             filter: brightness(0) invert(1); 
        }

        .btn {
            padding: 0.85rem 1.75rem;
            border-radius: 8px; 
            font-family: var(--font-title);
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s, color 0.2s, border-color 0.2s;
            cursor: pointer;
            text-align: center;
            text-transform: uppercase; 
            letter-spacing: 0.05em;
            border: none;
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: #702b82; 
        }
        .btn-secondary { 
            background-color: #e2e8f0;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        .btn-success { 
            background-color: var(--color-secondary);
            color: white;
        }
        .btn-success:hover {
            background-color: #c4003f; 
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            margin-bottom: 1rem; 
            height: 12px;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--color-secondary); 
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        
        .input-field { 
            font-family: var(--font-text);
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
            background-color: white; 
        }
        .input-field:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(134, 51, 153, 0.3);
        }

        /* Results Screen Specific Styles */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            align-items: flex-start;
            margin-bottom: 2rem; 
        }
        @media (min-width: 768px) { 
            .results-grid {
                grid-template-columns: 1.2fr 1fr; 
            }
        }
        .module-results-chart h3, .patrimonial-results-display h3, .results-legend-container h3, #personalDataNarrativeContainer h3 { 
            font-family: var(--font-title);
            font-weight: 700;
            font-size: 1.5rem; 
            color: white;
            background-color: var(--color-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .bar-chart-item {
            margin-bottom: 1rem;
            font-family: var(--font-text);
        }
        .bar-chart-label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #4A5568; 
        }
        .bar-container {
            background-color: #E2E8F0; 
            border-radius: 4px;
            height: 28px; 
            width: 100%;
            position: relative;
            overflow: hidden; 
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out, background-color 0.5s ease-out; 
            display: flex;
            align-items: center;
            justify-content: flex-end; 
            padding-right: 8px; 
            box-sizing: border-box;
        }
         .bar-percentage-text {
            font-size: 0.8rem;
            color: white;
            font-weight: 600;
        }

        .overall-result-display {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .overall-result-display p {
             font-family: var(--font-text);
             font-size: 1.125rem; 
             color: #4A5568; 
             margin-bottom: 0.5rem;
        }
        .overall-percentage-box {
            color: white;
            font-family: var(--font-title);
            font-weight: 900;
            font-size: 3rem; 
            padding: 1.5rem 1rem;
            border-radius: 12px;
            display: inline-block;
            min-width: 120px; 
            line-height: 1;
            margin-bottom: 1.5rem;
            transition: background-color 0.5s ease-out;
        }
        .results-message-container { 
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
        }
         .results-message-container h3 { 
            font-size: 1.75rem; 
            color: var(--color-primary); 
            margin-bottom: 0.75rem;
        }
        .results-message-container p {
            font-family: var(--font-text);
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .patrimonial-results-display, #personalDataNarrativeContainer { 
            background-color: #f8fafc; 
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            width: 100%; 
            margin-top: 2rem; 
        }
        #personalDataNarrativeContainer h3 {
             font-size: 1.5rem; 
        }

        #personalDataNarrativeText p {
            font-family: var(--font-text);
            font-size: 1rem;
            line-height: 1.7;
            text-align: left;
            color: #333;
            margin-bottom: 1rem; /* Space between paragraphs */
        }

        .patrimonial-results-display .numero-magico {
            font-family: var(--font-title);
            font-weight: 900;
            font-size: 3.5rem; 
            color: var(--color-secondary);
            text-align: center;
            margin-bottom: 0.5rem; 
            line-height: 1.1;
        }
         .patrimonial-results-display .numero-magico-label {
            font-family: var(--font-text);
            font-size: 1rem;
            color: #555;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .patrimonial-results-display p { 
            font-family: var(--font-text);
            font-size: 0.95rem; 
            color: #333;
            line-height: 1.6;
            margin-bottom: 0.75rem;
            text-align: left; 
        }
        .patrimonial-results-display .text-xs { 
            font-size: 0.8rem;
            color: #555;
            text-align: left;
        }
        .patrimonial-cta-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .patrimonial-cta-buttons .btn {
            border: 2px solid transparent;
        }
        .btn-cta-achieved {
            background-color: var(--color-cta-achieved-bg);
            color: var(--color-cta-achieved-text);
            border-color: var(--color-cta-achieved-border);
        }
        .btn-cta-achieved:hover {
            background-color: var(--color-cta-achieved-hover-bg);
        }
        .btn-cta-achieved.active, .btn-cta-achieved:active {
            background-color: var(--color-cta-achieved-active-bg);
            color: var(--color-cta-achieved-active-text);
            border-color: var(--color-cta-achieved-active-bg);
        }
        .btn-cta-not-achieved {
            background-color: var(--color-cta-not-achieved-bg);
            color: var(--color-cta-not-achieved-text);
            border-color: var(--color-cta-not-achieved-border);
        }
        .btn-cta-not-achieved:hover {
            background-color: var(--color-cta-not-achieved-hover-bg);
        }
        .btn-cta-not-achieved.active, .btn-cta-not-achieved:active {
            background-color: var(--color-cta-not-achieved-active-bg);
            color: var(--color-cta-not-achieved-active-text);
            border-color: var(--color-cta-not-achieved-active-bg);
        }


        @media (min-width: 640px) { 
            .patrimonial-cta-buttons {
                flex-direction: row;
                justify-content: center;
            }
            .patrimonial-cta-buttons .btn {
                width: auto;
            }
        }
        .motivational-text {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            background-color: #eef2ff; 
            border: 1px solid #c7d2fe; 
            color: #4338ca; 
            font-family: var(--font-text);
            font-size: 0.95rem;
            line-height: 1.6;
            text-align: left;
        }


        .results-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-family: var(--font-text);
            font-size: 0.9rem;
        }
        .legend-color-swatch {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            margin-right: 0.75rem;
            border: 1px solid rgba(0,0,0,0.1);
        }


        /* Loading Spinner */
        .spinner-overlay { 
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--color-primary);
            animation: spin 1s ease infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Responsive adjustments */
        @media (max-width: 767px) { 
            .quiz-container {
                margin: 1rem;
                padding: 1.5rem;
            }
            .question-block { 
                padding: 1rem;
            }
            .btn {
                width: 100%;
                margin-top: 0.75rem;
                padding: 1rem 1.5rem; 
            }
             .navigation-buttons .btn-secondary { 
                margin-bottom: 0.5rem;
            }
            .results-buttons-container .btn {
                 margin-bottom: 0.75rem;
            }
            .section-info-column {
                margin-bottom: 1rem; 
            }
            .results-grid {
                grid-template-columns: 1fr; 
            }
            .patrimonial-results-display .numero-magico {
                font-size: 2.5rem; 
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="quizApp" class="quiz-container">
        <!-- Pantalla Inicial -->
        <div id="initialScreen">
            <img id="testLogo" src="https://img1.wsimg.com/isteam/ip/5a112341-ad0f-4890-9c15-42df6c8fd70f/LOGO%20ARV.png/:/rs=h:175,m" alt="Icono del test de finanzas" class="mx-auto mb-6 h-20 w-auto">
            <h1 class="text-4xl font-league-spartan-black text-center mb-6">¡Evalúa tu Salud Financiera Hoy!</h1>
            <p class="text-lg text-center mb-8 leading-relaxed" style="font-family: var(--font-text);">Este test rápido y sencillo te dará una visión clara de tu situación financiera actual. ¡No necesitas ser un experto, solo responder con honestidad!</p>
            <button id="startQuizBtn" class="btn btn-primary w-full sm:w-auto mx-auto block text-lg">¡Empezar el Test!</button>
        </div>
        
        <!-- Pantalla de Aviso Legal -->
        <div id="disclaimerScreen" class="hidden">
            <h2 class="text-3xl font-league-spartan-black text-center mb-6">Antes de Comenzar</h2>
            <div class="space-y-4 text-sm text-gray-700 leading-relaxed" style="font-family: var(--font-text);">
                <p>Este test de finanzas personales es una herramienta interactiva diseñada para ofrecerte una perspectiva general y educativa sobre tu situación financiera actual. Los resultados y recomendaciones proporcionados pretenden servir como una guía inicial y un punto de partida para tu planificación financiera.</p>
                <p><strong>Importante:</strong> La información generada por este test no constituye, bajo ninguna circunstancia, asesoramiento financiero profesional, legal o fiscal. Cada situación financiera es única, y las decisiones importantes deben tomarse en consulta con profesionales calificados que puedan analizar tu contexto particular.</p>
                <p>Los datos personales que ingreses a continuación, como tu nombre y edad, se utilizan únicamente con el fin de personalizar tu experiencia dentro de este test y para los cálculos presentados. <strong>No almacenamos ni compartimos esta información personal.</strong> Tu privacidad es importante para nosotros.</p>
                <p>Al continuar, aceptas que comprendes estas limitaciones y utilizas esta herramienta bajo tu propia responsabilidad.</p>
            </div>
            <button id="acceptDisclaimerBtn" class="btn btn-primary w-full sm:w-auto mx-auto block mt-8 text-lg">Aceptar y Continuar</button>
        </div>

        <!-- Pantalla de Datos Personales -->
        <div id="personalDataScreen" class="hidden">
            <div class="question-section-layout">
                <div class="section-info-column">
                    <h2 class="font-league-spartan-black">Información Personal</h2>
                    <p>Un poco sobre ti nos ayudará a personalizar tu análisis y las recomendaciones que recibirás al final del test.</p>
                </div>
                <div id="personalDataQuestionsContainer">
                    <!-- Las preguntas se cargarán aquí con JavaScript -->
                </div>
            </div>
            <p id="personalDataError" class="text-red-500 text-sm mt-4 text-center hidden"></p>
            <div class="navigation-buttons flex flex-col sm:flex-row justify-between items-center mt-8">
                 <button id="backBtnPersonalData" class="btn btn-secondary"> &lt; Regresar</button>
                <button id="startMainQuizBtn" class="btn btn-primary">Continuar al Test</button>
            </div>
        </div>

        <!-- Pantalla del Test Principal -->
        <div id="quizScreen" class="hidden">
            <div id="quizHeader" class="mb-6"> 
                 <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
                </div>
                <p id="sectionCounter" class="text-sm text-gray-500 text-center" style="font-family: var(--font-text);"></p>
            </div>

            <div class="question-section-layout">
                <div class="section-info-column">
                    <h2 id="sectionTitle" class="font-league-spartan-black"></h2>
                    <p id="sectionSubtitle" style="font-family: var(--font-text);"></p>
                </div>
                <div id="allQuestionsContainer"> 
                    <!-- Las preguntas de la sección se cargarán aquí -->
                </div>
            </div>
            <p id="selectionError" class="text-red-500 text-sm mt-4 text-center hidden">Por favor, responde todas las preguntas de esta sección.</p>
            <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between items-center mt-8">
                <button id="backBtnQuiz" class="btn btn-secondary"> &lt; Regresar</button>
                <button id="nextSectionBtn" class="btn btn-primary">Siguiente</button> 
            </div>
        </div>

        <!-- Pantalla de Objetivo Patrimonial -->
        <div id="patrimonialObjectiveInputScreen" class="hidden"> 
            <h2 class="text-3xl font-league-spartan-black text-center mb-4">¡Ya casi terminas!</h2>
            <p class="text-center text-gray-700 mb-2 text-lg" style="font-family: var(--font-text);">¿Qué tan relacionados están tus hábitos financieros con la acumulación de tu patrimonio?</p>
            <p class="text-sm text-center text-gray-600 mb-8 leading-relaxed" style="font-family: var(--font-text);">Existe una fórmula que te sirve como punto de referencia para calcular cuál es el valor ideal de tus activos financieros que deberías tener en este momento, así te puedes dar una estimación de qué tanto has avanzado en tu planificación financiera, ¿Te atreves a conocer tus resultados?</p>
            
            <div class="space-y-6 mb-8"> 
                <div>
                    <label for="currentAge" class="block text-md font-semibold text-gray-700 mb-1" style="font-family: var(--font-text);">Tu edad actual (entre 18 y 70 años):</label>
                    <input type="number" id="currentAge" name="currentAge" class="input-field shadow-sm" placeholder="Ej: 30" min="18" max="70">
                </div>
                <div>
                    <label for="avgMonthlyIncome" class="block text-md font-semibold text-gray-700 mb-1" style="font-family: var(--font-text);">Tu ingreso mensual promedio (MXN):</label>
                    <input type="number" id="avgMonthlyIncome" name="avgMonthlyIncome" class="input-field shadow-sm" placeholder="Ej: 25000">
                </div>
                <div id="investorProfileQuestionContainer">
                    <!-- La pregunta de perfil de inversionista se cargará aquí -->
                </div>
            </div>
            <p id="investorProfileError" class="text-red-500 text-sm mt-2 text-center hidden">Por favor, selecciona tu perfil de inversionista.</p>
            <div class="navigation-buttons flex flex-col sm:flex-row justify-between items-center mt-10"> 
                 <button id="backBtnPatrimonialInput" class="btn btn-secondary"> &lt; Regresar</button>
                 <button id="generateReportBtn" class="btn btn-primary">Generar Mi Reporte</button> 
            </div>
        </div>
        
        <!-- Pantalla de Carga -->
        <div id="loadingScreen" class="spinner-overlay hidden"> 
            <div class="spinner"></div>
            <p id="loadingText" class="text-xl font-league-spartan-black" style="color: var(--color-primary);">Generando reporte...</p>
        </div>

        <!-- Pantalla de Resultados -->
        <div id="resultsScreen" class="hidden">
            <h1 id="resultsScreenTitle" class="text-4xl font-league-spartan-black text-center mb-8">¡Tus Resultados Están Aquí!</h1>
            
            <div class="results-grid">
                <div class="module-results-chart">
                    <h3>Resultados por módulos</h3>
                    <div id="moduleChartContainer"></div>
                </div>
                <div class="overall-results-summary">
                    <div class="overall-result-display">
                        <p>Tu resultado general es:</p>
                        <div id="overallPercentageBox" class="overall-percentage-box">
                            <span id="scorePercentage">0%</span>
                        </div>
                    </div>
                    <div id="resultsMessageContainer" class="results-message-container">
                        <h3 id="resultsTitle" class="font-league-spartan-black"></h3> 
                        <p id="resultsComment"></p>
                        <p id="resultsRecommendation" class="font-semibold"></p>
                    </div>
                </div>
            </div>
            
            <div id="personalDataNarrativeContainer" class="hidden">
                 <h3>Tu Perfil Financiero Detallado</h3>
                 <div id="personalDataNarrativeText"></div>
            </div>

            <div id="finalPatrimonialResultsContainer" class="patrimonial-results-display"></div>

            <div id="resultsLegendContainer" class="results-legend-container mt-8 pt-6 border-t border-gray-300">
                 <h3>Guía de Niveles y Colores</h3>
                 <div id="legendItemsContainer" class="mt-4 space-y-2"></div>
            </div>

            <div class="mt-10 flex flex-col sm:flex-row justify-center sm:space-x-4 results-buttons-container">
                <button id="restartQuizBtn" class="btn btn-primary">Volver a Empezar</button>
                <button id="downloadPdfBtn" class="btn btn-success">Descargar PDF</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration and Data ---
        const quizConfig = {
            loadingDelay: 1500, 
        };

        const personalDataQuestions = [
            {
                id: "nombre",
                question: "¿Cuál es tu nombre?",
                type: "text",
                name: "nombre",
                placeholder: "Escribe tu nombre aquí"
            },
            {
                id: "edad",
                question: "¿Cuántos años tienes?",
                type: "radio",
                name: "edad",
                options: ["18 a 24 años", "25 a 34 años", "35 a 44 años", "45 a 54 años", "55 años o más"]
            },
            {
                id: "estadoCivil",
                question: "¿Cuál es tu estado civil?",
                type: "radio",
                name: "estadoCivil",
                options: ["Soltero(a)", "Casado(a)", "Divorciado(a)", "Viudo(a)", "Unión libre"]
            },
            {
                id: "dependientes",
                question: "¿Tienes dependientes económicos?",
                type: "radio",
                name: "dependientes",
                options: ["Sí", "No"]
            },
            {
                id: "vidaLaboral",
                question: "¿Hace cuánto tiempo iniciaste tu vida laboral (años)?",
                type: "number",
                name: "vidaLaboral",
                placeholder: "Ej: 5"
            },
            {
                id: "ocupacion",
                question: "¿Cuál es tu ocupación laboral principal?",
                type: "radio",
                name: "ocupacion",
                options: ["Empleado(a) por cuenta ajena", "Trabajador(a) independiente/Freelancer", "Empresario(a)", "Estudiante", "Jubilado(a)", "Otro (especificar)"]
            },
            {
                id: "otraFuenteIngreso",
                question: "¿Además de tu trabajo, hay otra fuente de ingreso familiar?",
                type: "radio",
                name: "otraFuenteIngreso",
                options: ["Sí (especificar)", "No"]
            },
            {
                id: "rangoIngresos",
                question: "¿Cuál es tu rango de ingresos mensuales aproximado?",
                type: "radio",
                name: "rangoIngresos",
                options: ["Menos de $20,000 MXN", "$20,001-$30,000 MXN", "$30,001-$50,000 MXN", "$50,001-$100,000 MXN", "Más de $100,000 MXN"]
            },
            {
                id: "vivienda",
                question: "¿Vives en casa propia o rentada?",
                type: "radio",
                name: "vivienda",
                options: ["Propia", "Rentada"]
            },
            {
                id: "transporte",
                question: "¿Qué tipo de transporte utilizas?",
                type: "radio",
                name: "transporte",
                options: ["Auto propio", "Transporte público", "Otro"]
            },
            {
                id: "fondoEmergencia",
                question: "¿Tienes un fondo de emergencia?",
                type: "radio",
                name: "fondoEmergencia",
                options: ["Sí, suficiente para al menos 6 meses de gastos.", "Sí, pero no suficiente para 6 meses.", "No, no tengo un fondo de emergencia."]
            },
            {
                id: "deudas",
                question: "¿Tienes deudas actualmente (tarjetas de crédito, préstamos, etc.)?",
                type: "radio",
                name: "deudas",
                options: ["No, no tengo deudas.", "Sí, deudas menores y controladas.", "Sí, deudas importantes que me preocupan."]
            },
            {
                id: "preocupacion",
                question: "¿Cuál es tu principal preocupación respecto al dinero?",
                type: "radio",
                name: "preocupacion",
                options: [
                    "Me preocupa no tener un control claro de mis ingresos y gastos.",
                    "Me preocupa no estar ahorrando lo suficiente para mis metas.",
                    "Me preocupa tener demasiadas deudas o no saber cómo manejar mi crédito.",
                    "Me preocupa no saber cómo invertir mi dinero para hacerlo crecer.",
                    "Me preocupa no estar preparado financieramente para mi retiro.",
                    "Me preocupa no tener la protección adecuada en caso de imprevistos."
                ]
            },
            {
                id: "conocimientosFinancieros",
                question: "¿Cómo calificarías tus conocimientos sobre finanzas personales?",
                type: "radio",
                name: "conocimientosFinancieros",
                options: ["Muy alto", "Alto", "Medio", "Bajo", "Muy bajo"]
            }
        ];

        const investorProfileQuestion = {
            id: "investorProfile",
            question: "Al invertir tu dinero, ¿cuál de las siguientes afirmaciones describe mejor tu actitud hacia el riesgo y el rendimiento?",
            options: [
                { text: "Prefiero la seguridad ante todo. Busco proteger mi capital, aunque eso signifique obtener rendimientos modestos pero estables.", rate: 0.06, profileName: "Conservador" },
                { text: "Busco un equilibrio entre seguridad y crecimiento. Estoy dispuesto/a a asumir un nivel de riesgo bajo a moderado para obtener rendimientos un poco mayores.", rate: 0.08, profileName: "Moderado" },
                { text: "Estoy enfocado/a en el crecimiento de mi capital a largo plazo. Acepto un nivel de riesgo moderado a alto para buscar rendimientos significativos.", rate: 0.10, profileName: "Crecimiento" },
                { text: "Mi principal objetivo es maximizar mis rendimientos. Estoy dispuesto/a a asumir un alto nivel de riesgo para tener la oportunidad de obtener ganancias elevadas.", rate: 0.12, profileName: "Agresivo" }
            ]
        };


        const quizSections = [
            {
                title: "Presupuesto", 
                fullTitle: "Presupuesto - Tu Mapa Financiero Personal",
                subtitle: "Un presupuesto sólido es la base para alcanzar tus sueños financieros. ¡Descubre qué tan bien estás gestionando tus ingresos y gastos!",
                questions: [
                    {
                        id: "presupuesto1", text: "¿Tienes un sistema claro para llevar el registro de tus ingresos y gastos?",
                        options: [
                            { text: "¡Por supuesto! Llevo un registro detallado a diario, reviso mis finanzas cada semana y hago un análisis profundo al final de cada mes. Tengo una visión clara de dónde va cada peso.", score: 3 },
                            { text: "Intento registrar todo, pero a veces se me escapan algunos gastos. Hago revisiones mensuales cuando puedo.", score: 2 },
                            { text: "Solo registro los gastos importantes de vez en cuando. No tengo un sistema muy definido.", score: 1 },
                            { text: "No llevo ningún registro. Simplemente gasto según necesito.", score: 0 }
                        ]
                    },
                    {
                        id: "presupuesto2", text: "¿Tu presupuesto es un plan de acción que realmente sigues?",
                        options: [
                            { text: "Mi presupuesto es mi hoja de ruta financiera. Cada mes, asigno fondos a gastos fijos, metas, ahorro de emergencia y disfrute personal, y me apego a él rigurosamente.", score: 3 },
                            { text: "Tengo un presupuesto para gastos esenciales y personales, y generalmente trato de respetarlo.", score: 2 },
                            { text: "Hago un presupuesto en mi cabeza, pero a menudo termino gastando más de lo previsto.", score: 1 },
                            { text: "No tengo presupuesto. Gasto según lo que tengo disponible en el momento.", score: 0 }
                        ]
                    },
                    {
                        id: "presupuesto3", text: "¿Vives consistentemente por debajo de tus posibilidades?",
                        options: [
                            { text: "Sí, siempre. Mi objetivo es que mis ingresos superen mis gastos para poder ahorrar e invertir. Tengo un colchón financiero saludable.", score: 3 },
                            { text: "Generalmente, mis ingresos cubren mis gastos, aunque hay meses en que llego justo.", score: 2 },
                            { text: "A veces mis gastos superan mis ingresos, especialmente cuando hay imprevistos.", score: 1 },
                            { text: "Casi siempre gasto más de lo que gano. Suelo depender de tarjetas de crédito o préstamos.", score: 0 }
                        ]
                    }
                ]
            },
            {
                title: "Ahorro",
                fullTitle: "Ahorro - El Pilar de tu Futuro",
                subtitle: "Construye tu seguridad financiera paso a paso. Descubre si tus hábitos de ahorro te están llevando hacia tus metas.",
                questions: [
                    {
                        id: "ahorro1", text: "¿Dónde guardas principalmente tus ahorros?",
                        options: [
                            { text: "Ahorro en instituciones financieras reguladas que ofrecen rendimientos.", score: 3 },
                            { text: "Solo guardo mi dinero en la cuenta de débito o nómina.", score: 2 },
                            { text: "Ahorro en casa o en métodos informales como \"tandas\".", score: 1 },
                            { text: "No ahorro.", score: 0 }
                        ]
                    },
                    {
                        id: "ahorro2", text: "¿Cómo priorizas el ahorro en tu presupuesto?",
                        options: [
                            { text: "Ahorro antes de gastar, separando una cantidad fija primero.", score: 3 },
                            { text: "Ahorro después de gastar, si sobra algo, aunque lo hago cada mes.", score: 2 },
                            { text: "Ahorro solo si me sobra dinero después de gastar, \"¡Me lo merezco!\".", score: 1 },
                            { text: "Definitivamente no ahorro.", score: 0 }
                        ]
                    },
                    {
                        id: "ahorro3", text: "¿Alguna vez has usado tus ahorros para cubrir gastos imprevistos o \"gustos\"?",
                        options: [
                            { text: "Nunca uso mis ahorros como \"caja chica\" y los invierto para evitar tentaciones.", score: 3 },
                            { text: "En algunas ocasiones he tomado de mis ahorros, pero trato de reponerlo, aunque no siempre lo logro.", score: 2 },
                            { text: "A pesar de tener ahorros en casa, nunca los he usado para imprevistos o gustos.", score: 1 },
                            { text: "Casi siempre que tengo ahorros, termino gastándolos.", score: 0 }
                        ]
                    }
                ]
            },
            {
                title: "Crédito",
                fullTitle: "Crédito - Tu Herramienta Financiera",
                subtitle: "Aprende a usar el crédito a tu favor. Explora tus hábitos crediticios y descubre cómo optimizar tus deudas.",
                questions: [
                    {
                        id: "credito1", text: "Antes de solicitar un crédito, ¿qué haces?",
                        options: [
                            { text: "Calculo mi capacidad de pago, registrando mis ingresos y gastos detalladamente.", score: 3 },
                            { text: "Trato de calcularlo regularmente, pero a veces olvido algunos gastos.", score: 2 },
                            { text: "Pocas veces calculo mi capacidad de pago, solo para gastos o ingresos importantes.", score: 1 },
                            { text: "No hago ningún cálculo o no he solicitado créditos.", score: 0 }
                        ]
                    },
                    {
                        id: "credito2", text: "¿Cómo manejas el pago de tu tarjeta de crédito?",
                        options: [
                            { text: "Siempre pago el total de mis consumos y actualmente tengo saldo en \"0\".", score: 3 },
                            { text: "Siempre pago el total de mis consumos y solo tengo saldo de compras a meses sin intereses.", score: 2 },
                            { text: "A veces \"No llego a la quincena\" y he tenido que pagar el mínimo.", score: 1 },
                            { text: "Casi siempre pago el mínimo / No tengo una tarjeta de crédito.", score: 0 }
                        ]
                    },
                    {
                        id: "credito3", text: "¿Para qué sueles utilizar los Meses Sin Intereses (MSI)?",
                        options: [
                            { text: "Solo para bienes duraderos o inversiones, como muebles o domiciliaciones de planes de inversión.", score: 3 },
                            { text: "Mayormente, aunque también para ropa, celulares u otros gastos diarios.", score: 2 },
                            { text: "Suelo comprar también mi despensa, vacaciones, restaurantes caros y servicios con MSI.", score: 1 },
                            { text: "Casi todo lo compro a \"MSI\" / No tengo tarjeta de crédito.", score: 0 }
                        ]
                    }
                ]
            },
            {
                title: "Inversión",
                fullTitle: "Inversión - Haciendo Crecer tu Patrimonio",
                subtitle: "Pon tu dinero a trabajar por ti. Evalúa tus estrategias de inversión y cómo puedes maximizar tus rendimientos.",
                questions: [
                    {
                        id: "inversion1", text: "Antes de invertir, ¿qué pasos sigues?",
                        options: [
                            { text: "Lo hice en acompañamiento de un profesional.", score: 3 },
                            { text: "Lo hice por mi propia cuenta.", score: 2 },
                            { text: "No lo hice, solo invertí porque los rendimientos eran atractivos.", score: 1 },
                            { text: "No he invertido.", score: 0 }
                        ]
                    },
                    {
                        id: "inversion2", text: "¿Qué entiendes por \"Meter los huevos en la misma canasta\"?",
                        options: [
                            { text: "Se trata de diversificar en inversiones que entiendas y puedas controlar el riesgo.", score: 3 },
                            { text: "Se trata de diversificar en cualquier inversión que te ofrezca un buen rendimiento.", score: 2 },
                            { text: "Se trata de tener tu estrategia de inversión en un solo activo para obtener mejores rendimientos a largo plazo.", score: 1 },
                            { text: "No lo conozco.", score: 0 }
                        ]
                    },
                    {
                        id: "inversion3", text: "¿Tienes una estrategia de inversión diversificada?",
                        options: [
                            { text: "Tengo una estrategia para mis metas de 1 a 3 años, 3 a 5 años y más de 5 años.", score: 3 },
                            { text: "Solamente hago mis estrategias para metas de 1 a 5 años.", score: 2 },
                            { text: "Solamente hago mis estrategias para metas de 1 a 3 años.", score: 1 },
                            { text: "No la tengo.", score: 0 }
                        ]
                    }
                ]
            },
            {
                title: "Retiro",
                fullTitle: "Retiro - Tu Futuro Seguro",
                subtitle: "Planifica hoy para disfrutar mañana. Analiza tu preparación para el retiro y cómo asegurar tu bienestar financiero a largo plazo.",
                questions: [
                    {
                        id: "retiro1", text: "¿Cómo estás planeando tu retiro?",
                        options: [
                            { text: "Tengo un plan de retiro diversificado con seguros, \"ppr\", negocio, afore, casas de bolsa, inmuebles, entre otros.", score: 3 },
                            { text: "Prefiero solo invertir en un negocio o bienes inmuebles.", score: 2 },
                            { text: "Solamente me jubilaré con mi afore/seguridad social.", score: 1 },
                            { text: "No pienso en mi retiro.", score: 0 }
                        ]
                    },
                    {
                        id: "retiro2", text: "¿Tienes una idea clara de cuánto dinero necesitarás para tu retiro?",
                        options: [
                            { text: "Lo sé y tengo un plan financiero para lograrlo.", score: 3 },
                            { text: "Lo sé pero aún no tengo un plan financiero para lograrlo.", score: 2 },
                            { text: "Solamente pienso retirarme con lo que reciba de mi afore/seguridad social.", score: 1 },
                            { text: "No tengo idea.", score: 0 }
                        ]
                    },
                    {
                        id: "retiro3", text: "¿Cuánto ahorras para tu retiro?",
                        options: [
                            { text: "Ahorro al menos el 10% de mis ingresos constantemente.", score: 3 },
                            { text: "Ahorro menos del 10% pero lo hago constantemente.", score: 2 },
                            { text: "Solo ahorro cuando me sobra algo de dinero.", score: 1 },
                            { text: "No ahorro para mi retiro o solo lo que cotizo en mi afore/seguridad social.", score: 0 }
                        ]
                    }
                ]
            },
            {
                title: "Seguros",
                fullTitle: "Seguros - Tu Red de Protección",
                subtitle: "Protege lo que más valoras. Evalúa tus coberturas de seguro y cómo salvaguardar tu futuro y el de tu familia.",
                questions: [
                    {
                        id: "seguros1", text: "¿Tienes un seguro de vida e invalidez?",
                        options: [
                            { text: "Sí lo tengo ya que me asesoré con un profesional.", score: 3 },
                            { text: "Tengo un seguro, pero no cubre 5 años de mis gastos mensuales.", score: 2 },
                            { text: "Solamente compré uno básico en el banco.", score: 1 },
                            { text: "No tengo ningún seguro de vida.", score: 0 }
                        ]
                    },
                    {
                        id: "seguros2", text: "¿Tienes un seguro de casa-habitación?",
                        options: [
                            { text: "Si lo tengo.", score: 3 },
                            { text: "No sabía que podía contratarlo aunque no sea dueño de la propiedad y pienso comprarlo.", score: 2 },
                            { text: "Tal vez en un futuro lo considere.", score: 1 },
                            { text: "No lo considero necesario.", score: 0 }
                        ]
                    },
                    {
                        id: "seguros3", text: "¿Cómo consideras un seguro?",
                        options: [
                            { text: "Totalmente de acuerdo, lo considero una inversión.", score: 3 },
                            { text: "Depende: si es un seguro de ahorro, es una inversión, pero si no es de ahorro, es un gasto.", score: 2 },
                            { text: "No lo había pensado.", score: 1 },
                            { text: "Definitivamente es un gasto.", score: 0 }
                        ]
                    }
                ]
            }
        ];
        const resultsLevels = [ 
            { min: 0, max: 20, title: "Rescate Financiero Urgente", comment: "Tu situación financiera requiere atención inmediata. Es crucial implementar cambios drásticos y buscar ayuda profesional para evitar graves consecuencias. Estás en un punto crítico donde las decisiones que tomes ahora impactarán tu futuro financiero.", recommendation: "Busca asesoría financiera profesional de inmediato. Cursos básicos de finanzas personales, crear presupuesto estricto y eliminar deudas de alto interés.", colorClass: "border-red-500 bg-red-50 text-red-700", barColor: "#EF4444" },
            { min: 21, max: 40, title: "Despertar Financiero", comment: "Estás empezando a tomar conciencia de la importancia de tus finanzas, pero aún hay mucho por mejorar. Es momento de adquirir conocimientos y herramientas para tomar el control de tu dinero. Tienes el potencial de mejorar, pero necesitas acción y compromiso.", recommendation: "Aprende sobre presupuestos, ahorro y manejo de deudas. Metas financieras pequeñas y realistas. Explora recursos en línea y talleres/seminarios sobre finanzas personales.", colorClass: "border-orange-500 bg-orange-50 text-orange-700", barColor: "#F97316" },
            { min: 41, max: 60, title: "Camino a la Estabilidad", comment: "Has logrado avances significativos en tus finanzas, pero aún existen áreas de oportunidad. Estás construyendo una base sólida y, con algunos ajustes, puedes alcanzar una mayor estabilidad. Tus esfuerzos están dando frutos, pero la consistencia es clave.", recommendation: "Revisa y ajusta tu presupuesto regularmente. Inversiones a bajo riesgo y fondo de emergencia sólido. Diversifica ahorros y evalúa seguros.", colorClass: "border-yellow-500 bg-yellow-50 text-yellow-700", barColor: "#EAB308" },
            { min: 61, max: 80, title: "Potenciando tus Finanzas", comment: "Tienes un buen manejo de tus finanzas y estás en una posición sólida. Ahora es el momento de optimizar tus estrategias y buscar crecimiento financiero. Estás en una fase de crecimiento y refinamiento de tus habilidades financieras.", recommendation: "Inversiones más avanzadas y diversifica tu portafolio. Planifica para el retiro y evalúa tus seguros. Oportunidades para aumentar ingresos y mejorar planificación fiscal.", colorClass: "border-lime-500 bg-lime-50 text-lime-700", barColor: "#84CC16" }, 
            { min: 81, max: 100, title: "Maestro Financiero", comment: "Eres un experto en finanzas personales y estás en excelente forma. Tu enfoque disciplinado y estratégico te permitirá alcanzar tus metas financieras con éxito. Eres un modelo a seguir en cuanto a gestión financiera.", recommendation: "Continúa aprendiendo y adaptándote a los cambios del mercado. Mentorizar a otros y compartir tus conocimientos. Estrategias de inversión sofisticadas y planifica la transferencia de patrimonio.", colorClass: "border-green-500 bg-green-50 text-green-700", barColor: "#22C55E" }
        ];

        const personalDataObservations = {
            edad: {
                "18 a 24 años": "Estás en una etapa ideal para construir una base financiera sólida. Enfócate en el ahorro y la inversión a largo plazo para aprovechar el poder del tiempo.",
                "25 a 34 años": "Te encuentras en una fase de crecimiento. Es importante equilibrar tus metas actuales (como comprar una casa o formar una familia) con la planificación de tu futuro financiero, incluyendo el retiro.",
                "35 a 44 años": "Estás en un momento clave para consolidar tus finanzas. Revisa tus metas de ahorro e inversión y asegúrate de estar bien encaminado hacia un retiro cómodo.",
                "45 a 54 años": "La etapa del retiro se acerca. Es fundamental intensificar tus esfuerzos de ahorro, evaluar tus inversiones y considerar estrategias para generar ingresos en la jubilación.",
                "55 años o más": "Estás en la etapa de disfrutar tu retiro. La gestión prudente de tus recursos es esencial para asegurar tu bienestar financiero a largo plazo."
            },
            estadoCivil: {
                "Soltero(a)": "Tienes gran autonomía en tus decisiones financieras. Aprovecha para enfocarte en tus objetivos personales de ahorro e inversión.",
                "Casado(a)": "La planificación financiera en pareja es fundamental. La comunicación y los acuerdos mutuos sobre metas y gastos son clave para una salud financiera conjunta.",
                "Divorciado(a)": "Es un momento de reestructuración financiera. Definir un nuevo plan personal y establecer metas claras te ayudará a recuperar la estabilidad.",
                "Viudo(a)": "Atravesando un periodo de ajuste financiero. Buscar apoyo y asesoría te puede orientar en la gestión de los cambios y la protección de tu futuro.",
                "Unión libre": "Aunque no haya un vínculo legal formal, la gestión de finanzas compartidas requiere transparencia y acuerdos para evitar conflictos."
            },
            dependientes: {
                "Sí": "Tu responsabilidad financiera es mayor. Es vital contar con una red de seguridad, como seguros de vida adecuados y planes de ahorro para el futuro de tus dependientes.",
                "No": "Tienes mayor flexibilidad para asignar tus recursos. Aun así, la planificación a largo plazo y la protección ante imprevistos siguen siendo importantes para ti."
            },
            vidaLaboral: "Tu experiencia laboral es un factor importante en tu situación financiera. Considera cómo tu trayectoria ha influido en tus ingresos, oportunidades de crecimiento y planificación para el futuro.",
            ocupacion: {
                "Empleado(a) por cuenta ajena": "Tu situación como empleado(a) suele ofrecer ingresos más estables. Aprovecha los beneficios laborales disponibles (seguros, retiro) y planifica tu crecimiento dentro de la estructura de la empresa.",
                "Trabajador(a) independiente/Freelancer": "Como trabajador(a) independiente, tienes mayor flexibilidad pero también ingresos variables. Es crucial una planificación financiera rigurosa, incluyendo la gestión de impuestos y la creación de un fondo de emergencia robusto.",
                "Empresario(a)": "Ser empresario(a) implica desafíos y oportunidades financieras únicas. La gestión eficiente de tu negocio y la separación clara de tus finanzas personales son vitales para tu éxito.",
                "Estudiante": "Como estudiante, estás en una fase de inversión en tu futuro. Es un buen momento para aprender sobre finanzas personales, establecer hábitos de ahorro básicos y evitar deudas innecesarias.",
                "Jubilado(a)": "En la etapa de jubilación, tus ingresos provienen principalmente de ahorros y pensiones. La gestión cuidadosa de estos recursos y la planificación de gastos son clave para mantener tu calidad de vida.",
                "Otro (especificar)": "Tu ocupación particular influye en tus finanzas de maneras específicas. Considera cómo las características de tu trabajo afectan tus ingresos, gastos y oportunidades de planificación financiera."
            },
            otraFuenteIngreso: {
                "Sí (especificar)": "Contar con fuentes de ingreso adicionales fortalece tu situación financiera familiar. Es importante integrar estos ingresos en tu presupuesto general y considerar cómo pueden acelerar el logro de tus metas.",
                "No": "Actualmente, tu ingreso principal proviene de tu trabajo. Una gestión eficiente de este ingreso y la búsqueda de oportunidades de crecimiento son fundamentales para mejorar tu situación financiera."
            },
            rangoIngresos: {
                "Menos de $20,000 MXN": "Con un ingreso en este rango, es fundamental un control estricto de gastos y la búsqueda activa de oportunidades para aumentar tus ingresos.",
                "$20,001-$30,000 MXN": "En este rango, tienes una buena base para construir tu futuro financiero. Puedes enfocarte en metas de ahorro más ambiciosas y diversificar tus inversiones.",
                "$30,001-$50,000 MXN": "Con un ingreso moderado, tienes mayor capacidad de ahorro e incluso puedes empezar a explorar opciones básicas de inversión. Una planificación cuidadosa es clave.",
                "$50,001-$100,000 MXN": "Con un ingreso más alto, tus oportunidades de ahorro e inversión son mayores. Es un buen momento para buscar asesoría profesional y desarrollar una estrategia financiera a largo plazo.",
                "Más de $100,000 MXN": "Con un ingreso más alto, tus oportunidades de ahorro e inversión son mayores. Es un buen momento para buscar asesoría profesional y desarrollar una estrategia financiera a largo plazo."
            },
            vivienda: {
                "Propia": "Ser propietario de una casa implica responsabilidades financieras adicionales (impuestos, mantenimiento) pero también contribuye a tu patrimonio. Considera cómo gestionar estos gastos y el potencial de tu propiedad como inversión.",
                "Rentada": "Vivir de alquiler te ofrece flexibilidad. Puedes destinar una mayor parte de tus recursos al ahorro o la inversión para alcanzar metas como la compra de una vivienda en el futuro."
            },
            transporte: {
                "Auto propio": "Tener un auto propio genera gastos significativos (combustible, seguro, mantenimiento). Evalúa el costo real de poseer un vehículo y busca maneras de optimizar estos gastos.",
                "Transporte público": "Utilizar transporte público suele ser más económico. El ahorro en gastos de transporte puede ser destinado a otras metas financieras, como el ahorro o la inversión.",
                "Otro": "Tu opción de transporte particular influye en tus gastos de manera específica. Considera cómo estos costos afectan tu presupuesto general."
            },
            fondoEmergencia: {
                "Sí, suficiente para al menos 6 meses de gastos.": "¡Excelente! Contar con un fondo de emergencia sólido te brinda tranquilidad y seguridad ante imprevistos. Mantén este fondo intacto y reponlo si lo utilizas.",
                "Sí, pero no suficiente para 6 meses.": "Es un buen comienzo tener un fondo de emergencia, pero es crucial trabajar para alcanzar la meta de cubrir al menos 6 meses de gastos. Prioriza este ahorro hasta completarlo.",
                "No, no tengo un fondo de emergencia.": "Crear un fondo de emergencia es uno de los pasos más importantes en finanzas personales. Empieza a destinar una pequeña cantidad regularmente hasta construir una red de seguridad adecuada."
            },
            deudas: {
                "No, no tengo deudas.": "¡Felicidades! Mantenerte libre de deudas te da mayor libertad financiera. Continúa con una gestión prudente para evitar endeudamiento innecesario en el futuro.",
                "Sí, deudas menores y controladas.": "Tener deudas manejables es común. Es importante mantener un control estricto sobre ellas, realizar pagos a tiempo y buscar estrategias para liquidarlas eficientemente.",
                "Sí, deudas importantes que me preocupan.": "Las deudas importantes pueden generar un estrés significativo. Es fundamental evaluar tu situación, considerar opciones como la consolidación de deudas o buscar asesoría financiera para crear un plan de pago efectivo."
            },
            preocupacion: {
                "Me preocupa no tener un control claro de mis ingresos y gastos.": "Un buen punto de partida es llevar un registro detallado de tus finanzas. Utiliza herramientas como presupuestos y aplicaciones de seguimiento de gastos para visualizar y controlar tu dinero. Esto te dará mayor claridad y te ayudará a tomar mejores decisiones.",
                "Me preocupa no estar ahorrando lo suficiente para mis metas.": "Definir metas de ahorro específicas y realistas es el primer paso. Crea un plan de ahorro, automatiza tus aportaciones si es posible, y revisa tu presupuesto para identificar áreas donde puedes reducir gastos y aumentar tu capacidad de ahorro.",
                "Me preocupa tener demasiadas deudas o no saber cómo manejar mi crédito.": "Es fundamental evaluar tu situación de deuda. Considera opciones como la consolidación de deudas, la negociación con acreedores o buscar asesoría financiera para crear un plan de pago efectivo. Aprender sobre cómo funciona el crédito y cómo mejorarlo también es clave.",
                "Me preocupa no saber cómo invertir mi dinero para hacerlo crecer.": "La inversión puede ser una herramienta poderosa para aumentar tu patrimonio, pero requiere conocimiento. Empieza por investigar opciones de inversión que se ajusten a tu perfil de riesgo y metas financieras. Considera buscar asesoría profesional para dar los primeros pasos.",
                "Me preocupa no estar preparado financieramente para mi retiro.": "La planificación para el retiro debe comenzar cuanto antes. Explora opciones de planes de retiro, como fondos de pensiones o cuentas de ahorro individuales. Calcula cuánto necesitas ahorrar y crea un plan a largo plazo para asegurar tu futuro financiero en la jubilación.",
                "Me preocupa no tener la protección adecuada en caso de imprevistos.": "Contar con un fondo de emergencia y seguros adecuados es vital para protegerte ante situaciones inesperadas, como enfermedades, accidentes o pérdida de empleo. Evalúa tus necesidades de seguro (vida, salud, hogar, auto) y asegúrate de tener una red de seguridad financiera sólida."
            },
            conocimientosFinancieros: {
                "Muy alto": "Tienes una base sólida en finanzas personales. Continúa actualizándote y explorando estrategias avanzadas para optimizar tu situación financiera y alcanzar tus metas.",
                "Alto": "Posees buenos conocimientos financieros. Aprovecha esta base para profundizar en áreas específicas que te interesen y seguir mejorando tu gestión del dinero.",
                "Medio": "Tienes un conocimiento intermedio sobre finanzas personales. Es un buen momento para ampliar tu educación financiera, explorar nuevos temas y aplicar lo aprendido para mejorar tu situación.",
                "Bajo": "Tus conocimientos financieros son limitados. No te preocupes, todos empezamos en algún punto. Dedica tiempo a aprender los conceptos básicos, busca recursos educativos confiables y da pequeños pasos para mejorar tu comprensión y manejo del dinero.",
                "Muy bajo": "Estás al inicio de tu camino en las finanzas personales. Es fundamental empezar por lo básico. Busca información sencilla y clara, no dudes en hacer preguntas y enfócate en adquirir los conocimientos esenciales para tomar el control de tu situación financiera."
            }
        };

        // --- DOM Elements ---
        const quizAppEl = document.getElementById('quizApp'); 
        const initialScreen = document.getElementById('initialScreen');
        const disclaimerScreenEl = document.getElementById('disclaimerScreen'); 
        const personalDataScreen = document.getElementById('personalDataScreen');
        const quizScreen = document.getElementById('quizScreen');
        const quizHeaderEl = document.getElementById('quizHeader'); 
        const patrimonialObjectiveInputScreenEl = document.getElementById('patrimonialObjectiveInputScreen'); 
        const loadingScreenEl = document.getElementById('loadingScreen'); 
        const loadingTextEl = document.getElementById('loadingText');
        const resultsScreen = document.getElementById('resultsScreen');
        const moduleChartContainerEl = document.getElementById('moduleChartContainer');
        const finalPatrimonialResultsContainerEl = document.getElementById('finalPatrimonialResultsContainer');
        const overallPercentageBoxEl = document.getElementById('overallPercentageBox');
        const legendItemsContainerEl = document.getElementById('legendItemsContainer');
        const investorProfileQuestionContainerEl = document.getElementById('investorProfileQuestionContainer');
        const investorProfileErrorEl = document.getElementById('investorProfileError');
        const resultsScreenTitleEl = document.getElementById('resultsScreenTitle'); 
        const personalDataNarrativeContainerEl = document.getElementById('personalDataNarrativeContainer');
        const personalDataNarrativeTextEl = document.getElementById('personalDataNarrativeText');

        const startQuizBtn = document.getElementById('startQuizBtn');
        const acceptDisclaimerBtnEl = document.getElementById('acceptDisclaimerBtn'); 
        const startMainQuizBtn = document.getElementById('startMainQuizBtn');
        const personalDataQuestionsContainer = document.getElementById('personalDataQuestionsContainer');
        const personalDataErrorEl = document.getElementById('personalDataError');
        const backBtnPersonalDataEl = document.getElementById('backBtnPersonalData'); 

        
        const sectionTitleEl = document.getElementById('sectionTitle');
        const sectionSubtitleEl = document.getElementById('sectionSubtitle');
        const allQuestionsContainerEl = document.getElementById('allQuestionsContainer'); 
        const nextSectionBtn = document.getElementById('nextSectionBtn'); 
        const backBtnQuiz = document.getElementById('backBtnQuiz'); 
        const backBtnPatrimonialInput = document.getElementById('backBtnPatrimonialInput'); 

        const selectionErrorEl = document.getElementById('selectionError');
        const progressBarEl = document.getElementById('progressBar');
        const sectionCounterEl = document.getElementById('sectionCounter'); 

        const currentAgeInput = document.getElementById('currentAge');
        const avgMonthlyIncomeInput = document.getElementById('avgMonthlyIncome');
        const generateReportBtnEl = document.getElementById('generateReportBtn'); 

        const scorePercentageEl = document.getElementById('scorePercentage');
        const resultsMessageContainerEl = document.getElementById('resultsMessageContainer');
        const resultsTitleEl = document.getElementById('resultsTitle');
        const resultsCommentEl = document.getElementById('resultsComment');
        const resultsRecommendationEl = document.getElementById('resultsRecommendation');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');

        // --- State Variables ---
        let currentPersonalData = {};
        let currentSectionIndex = 0;
        let userAnswers = {}; 
        let sectionScores = {}; 
        let totalAnsweredQuestions = 0; 
        let totalQuizQuestions = quizSections.reduce((acc, section) => acc + section.questions.length, 0);
        let patrimonialDataForDisplay = null; 
        let screenHistory = []; 
        let selectedInvestorProfileRate = 0.06; 

        // --- Functions ---
        function scrollToTop(element) {
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else { 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function showScreen(screenElement, cameFromBack = false) {
            const allScreens = [initialScreen, disclaimerScreenEl, personalDataScreen, quizScreen, patrimonialObjectiveInputScreenEl, loadingScreenEl, resultsScreen];
            allScreens.forEach(s => {
                if (s) s.classList.add('hidden');
            });
            if (screenElement) {
                screenElement.classList.remove('hidden');
                if (!cameFromBack) { 
                    scrollToTop(quizAppEl); 
                }
            }

            if (!cameFromBack && screenElement) {
                const currentScreenId = screenElement.id;
                if (screenElement.id !== resultsScreen.id && screenElement.id !== initialScreen.id && screenElement.id !== loadingScreenEl.id) { 
                     if (screenHistory[screenHistory.length -1] !== currentScreenId) {
                        screenHistory.push(currentScreenId);
                     }
                }
            }
        }
        
        function goBack() {
            if (screenHistory.length > 1) { 
                const currentScreenIdPopped = screenHistory.pop(); 
                const previousScreenId = screenHistory[screenHistory.length - 1]; 
                const previousScreenElement = document.getElementById(previousScreenId);

                if (previousScreenElement) {
                    if (currentScreenIdPopped === personalDataScreen.id && previousScreenId === disclaimerScreenEl.id) {
                        // No specific state reset needed here
                    } else if (currentScreenIdPopped === quizScreen.id && previousScreenId === personalDataScreen.id) {
                        currentSectionIndex = 0;
                        userAnswers = {};
                        sectionScores = {};
                        totalAnsweredQuestions = 0;
                        updateProgressBar(); 
                    } else if (currentScreenIdPopped === patrimonialObjectiveInputScreenEl.id && previousScreenId === quizScreen.id) {
                        currentSectionIndex = quizSections.length -1; 
                    }
                    showScreen(previousScreenElement, true); 
                    scrollToTop(quizAppEl); 
                }
            } else if (screenHistory.length === 1 && disclaimerScreenEl && screenHistory[0] === disclaimerScreenEl.id) { 
                screenHistory.pop();
                showScreen(initialScreen, true);
                scrollToTop(quizAppEl);
            }
        }

        function loadPersonalDataQuestions() {
            if (!personalDataQuestionsContainer) return;
            personalDataQuestionsContainer.innerHTML = '';
            const formFragment = document.createDocumentFragment();

            personalDataQuestions.forEach((pdQuestion) => {
                const qDiv = document.createElement('div');
                qDiv.classList.add('mb-6');

                const qLabel = document.createElement('label');
                qLabel.classList.add('block', 'text-md', 'font-semibold', 'mb-1', 'text-gray-700');
                qLabel.style.fontFamily = 'var(--font-text)';
                qLabel.textContent = pdQuestion.question;
                if (pdQuestion.type === 'text' || pdQuestion.type === 'number') {
                    qLabel.htmlFor = pdQuestion.id;
                }
                qDiv.appendChild(qLabel);

                if (pdQuestion.type === 'text' || pdQuestion.type === 'number') {
                    const input = document.createElement('input');
                    input.type = pdQuestion.type;
                    input.name = pdQuestion.name;
                    input.id = pdQuestion.id;
                    input.placeholder = pdQuestion.placeholder || '';
                    input.classList.add('input-field', 'shadow-sm');
                    if (pdQuestion.type === 'number') {
                        input.min = "0";
                    }
                    input.value = currentPersonalData[pdQuestion.id] || '';
                    input.addEventListener('input', (e) => {
                        currentPersonalData[pdQuestion.id] = e.target.value.trim();
                    });
                    qDiv.appendChild(input);
                } else if (pdQuestion.type === 'radio') {
                    const hasSpecifyOption = pdQuestion.options.some(opt => opt.includes('(especificar)'));
                    
                    pdQuestion.options.forEach(optionText => {
                        const uniqueId = `${pdQuestion.name}_${optionText.replace(/\s+/g, '_').replace(/[¿?"'.!,]/g, '')}`;
                        const optionWrapper = document.createElement('label');
                        optionWrapper.classList.add('option-label');
                        optionWrapper.htmlFor = uniqueId;

                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = pdQuestion.name;
                        radio.value = optionText;
                        radio.id = uniqueId;
                        radio.classList.add('mr-3');

                        if (currentPersonalData[pdQuestion.id] === optionText) {
                            radio.checked = true;
                            optionWrapper.classList.add('selected');
                        }

                        optionWrapper.appendChild(radio);
                        optionWrapper.appendChild(document.createTextNode(optionText));
                        qDiv.appendChild(optionWrapper);

                        radio.addEventListener('change', () => {
                            document.querySelectorAll(`input[name="${pdQuestion.name}"]`).forEach(r => {
                                r.parentElement.classList.remove('selected');
                            });
                            optionWrapper.classList.add('selected');
                            currentPersonalData[pdQuestion.id] = radio.value;

                            if (hasSpecifyOption) {
                                const specifyWrapper = document.getElementById(`${pdQuestion.id}_specify_wrapper`);
                                if (radio.value.includes('(especificar)')) {
                                    specifyWrapper.classList.remove('hidden');
                                } else {
                                    specifyWrapper.classList.add('hidden');
                                    const specifyInput = document.getElementById(`${pdQuestion.id}_specify_text`);
                                    specifyInput.value = '';
                                    delete currentPersonalData[`${pdQuestion.id}_specify`];
                                }
                            }
                        });
                    });
                    
                    if (hasSpecifyOption) {
                        const specifyWrapper = document.createElement('div');
                        specifyWrapper.id = `${pdQuestion.id}_specify_wrapper`;
                        specifyWrapper.classList.add('mt-2');
                        if (currentPersonalData[pdQuestion.id] && currentPersonalData[pdQuestion.id].includes('(especificar)')) {
                            // is visible
                        } else {
                            specifyWrapper.classList.add('hidden');
                        }


                        const specifyLabel = document.createElement('label');
                        specifyLabel.htmlFor = `${pdQuestion.id}_specify_text`;
                        specifyLabel.textContent = "Por favor, especifica:";
                        specifyLabel.classList.add('text-sm', 'font-medium', 'text-gray-600');
                        
                        const specifyInput = document.createElement('input');
                        specifyInput.type = 'text';
                        specifyInput.id = `${pdQuestion.id}_specify_text`;
                        specifyInput.name = `${pdQuestion.id}_specify_text`;
                        specifyInput.classList.add('input-field', 'mt-1');
                        specifyInput.value = currentPersonalData[`${pdQuestion.id}_specify`] || '';


                        specifyInput.addEventListener('input', (e) => {
                             currentPersonalData[`${pdQuestion.id}_specify`] = e.target.value.trim();
                        });

                        specifyWrapper.appendChild(specifyLabel);
                        specifyWrapper.appendChild(specifyInput);
                        qDiv.appendChild(specifyWrapper);
                    }
                }
                formFragment.appendChild(qDiv);
            });
            personalDataQuestionsContainer.appendChild(formFragment);
        }
        
        function loadInvestorProfileQuestion() {
            if (!investorProfileQuestionContainerEl) return;
            investorProfileQuestionContainerEl.innerHTML = '';
            const q = investorProfileQuestion;

            const qLabel = document.createElement('p');
            qLabel.classList.add('text-md', 'font-semibold', 'text-gray-700', 'mb-3');
            qLabel.style.fontFamily = 'var(--font-text)';
            qLabel.textContent = q.question;
            investorProfileQuestionContainerEl.appendChild(qLabel);

            q.options.forEach(option => {
                const uniqueId = `${q.id}_${option.rate}`;
                const optionWrapper = document.createElement('label');
                optionWrapper.classList.add('option-label');
                optionWrapper.htmlFor = uniqueId;

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = q.id;
                radio.value = option.rate; 
                radio.id = uniqueId;
                radio.dataset.profileName = option.profileName; 

                optionWrapper.appendChild(radio);
                optionWrapper.appendChild(document.createTextNode(option.text));
                investorProfileQuestionContainerEl.appendChild(optionWrapper);

                radio.addEventListener('change', () => {
                    document.querySelectorAll(`input[name="${q.id}"]`).forEach(r => {
                        if(r.parentElement) r.parentElement.classList.remove('selected');
                    });
                    if (radio.checked) {
                        optionWrapper.classList.add('selected');
                        selectedInvestorProfileRate = parseFloat(radio.value);
                        if(investorProfileErrorEl) investorProfileErrorEl.classList.add('hidden');
                    }
                });
            });
        }


        function updateProgressBar() {
            let answeredQuizCount = 0;
            quizSections.forEach(section => {
                section.questions.forEach(question => {
                    if (userAnswers[question.id] !== undefined) {
                        answeredQuizCount++;
                    }
                });
            });
            totalAnsweredQuestions = answeredQuizCount; 

            const progress = totalQuizQuestions > 0 ? (totalAnsweredQuestions / totalQuizQuestions) * 100 : 0;
            if(progressBarEl) progressBarEl.style.width = `${progress}%`;
        }

        function loadSection() {
            if(selectionErrorEl) selectionErrorEl.classList.add('hidden');
            const section = quizSections[currentSectionIndex];

            if(sectionTitleEl) sectionTitleEl.textContent = section.fullTitle; 
            if(sectionSubtitleEl) sectionSubtitleEl.textContent = section.subtitle;
            if(sectionCounterEl) sectionCounterEl.textContent = `Sección ${currentSectionIndex + 1} de ${quizSections.length}`;
            
            if(nextSectionBtn) {
                if (currentSectionIndex === quizSections.length - 1) {
                    nextSectionBtn.textContent = "Siguiente"; 
                } else {
                    nextSectionBtn.textContent = "Siguiente Sección";
                }
            }

            if(allQuestionsContainerEl) allQuestionsContainerEl.innerHTML = ''; 
            
            section.questions.forEach(question => {
                const questionBlock = document.createElement('div');
                questionBlock.classList.add('question-block'); 

                const questionTextP = document.createElement('p');
                questionTextP.classList.add('text-lg', 'font-semibold', 'mb-4'); 
                questionTextP.style.fontFamily = 'var(--font-text)';
                questionTextP.style.color = '#333';
                questionTextP.textContent = question.text;
                questionBlock.appendChild(questionTextP);

                const optionsDiv = document.createElement('div');
                question.options.forEach(option => {
                    const uniqueId = `${question.id}_${option.score}_${currentSectionIndex}`; 
                    const label = document.createElement('label');
                    label.classList.add('option-label');
                    label.htmlFor = uniqueId;

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = question.id; 
                    radio.value = option.score;
                    radio.dataset.text = option.text;
                    radio.id = uniqueId;
                    
                    if (userAnswers[question.id] && userAnswers[question.id].score === option.score) {
                        radio.checked = true;
                        label.classList.add('selected');
                    }

                    label.appendChild(radio);
                    label.appendChild(document.createTextNode(" " + option.text));
                    optionsDiv.appendChild(label);

                    radio.addEventListener('change', () => {
                        document.querySelectorAll(`input[name="${question.id}"]`).forEach(r => {
                           if(r.parentElement) r.parentElement.classList.remove('selected');
                        });
                        if (radio.checked) {
                            if(label) label.classList.add('selected');
                            userAnswers[question.id] = {
                                score: parseInt(radio.value),
                                text: radio.dataset.text 
                            }; 
                        }
                        updateProgressBar(); 
                    });
                });
                questionBlock.appendChild(optionsDiv);
                if(allQuestionsContainerEl) allQuestionsContainerEl.appendChild(questionBlock);
            });
            
            updateProgressBar(); 
            scrollToTop(quizHeaderEl); 

            if (backBtnQuiz) {
                if (currentSectionIndex === 0) {
                    backBtnQuiz.classList.add('opacity-50', 'pointer-events-none'); 
                } else {
                    backBtnQuiz.classList.remove('opacity-50', 'pointer-events-none');
                }
            }
        }
        
        function calculateAndStoreSectionScores() {
            sectionScores = {}; 
            quizSections.forEach(section => {
                let currentSectionScore = 0;
                let questionsInSection = section.questions.length;
                if (questionsInSection === 0) {
                    sectionScores[section.title] = 0; 
                    return;
                }
                section.questions.forEach(question => {
                    if (userAnswers[question.id] !== undefined) {
                        currentSectionScore += userAnswers[question.id].score;
                    }
                });
                const maxSectionScore = questionsInSection * 3; 
                const percentage = maxSectionScore > 0 ? (currentSectionScore / maxSectionScore) * 100 : 0;
                sectionScores[section.title] = percentage;
            });
        }


        function handleNextSection() {
            const section = quizSections[currentSectionIndex];
            let allAnsweredInSection = true;
            
            for (const question of section.questions) {
                if (userAnswers[question.id] === undefined) { 
                    allAnsweredInSection = false;
                    break;
                }
            }

            if (!allAnsweredInSection) {
                if(selectionErrorEl) selectionErrorEl.classList.remove('hidden');
                return;
            }
            if(selectionErrorEl) selectionErrorEl.classList.add('hidden');
            
            currentSectionIndex++;
            if (currentSectionIndex < quizSections.length) {
                loadSection(); 
            } else {
                calculateAndStoreSectionScores(); 
                loadInvestorProfileQuestion(); 
                showScreen(patrimonialObjectiveInputScreenEl); 
            }
        }

        function handleBackSection() {
            if (currentSectionIndex > 0) {
                currentSectionIndex--;
                loadSection(); 
            } else {
                goBack(); 
            }
        }
        
        function calculatePatrimonialObjectiveData() { 
            const age = parseFloat(currentAgeInput ? currentAgeInput.value : 0);
            const income = parseFloat(avgMonthlyIncomeInput ? avgMonthlyIncomeInput.value : 0);
            patrimonialDataForDisplay = null; 

            if (isNaN(age) || age < 18 || age > 70) { 
                patrimonialDataForDisplay = { calculatedSuccessfully: false, message: "Por favor, ingresa una edad válida entre 18 y 70 años."};
                console.error(patrimonialDataForDisplay.message);
                return false;
            }
            if (isNaN(income) || income <= 0) {
                patrimonialDataForDisplay = { calculatedSuccessfully: false, message: "Por favor, ingresa un ingreso mensual válido."};
                console.error(patrimonialDataForDisplay.message);
                return false; 
            }
             if (age <= 26.5) { 
                patrimonialDataForDisplay = { calculatedSuccessfully: false, message: "La edad debe ser mayor a 26.5 para esta fórmula particular."};
                console.error(patrimonialDataForDisplay.message);
                return false; 
            }

            const yearsContribution = age - 26.5;
            const patrimonialObjective = yearsContribution * 2.65 * income;
            
            const yearsContributionDisplay = Math.round(yearsContribution); 


            const objectiveText = `Tu patrimonio mínimo recomendado es: $${patrimonialObjective.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} MXN.`; 
            let pureSavingsText = "";
            let investmentSavingsText = "";

            if (yearsContribution > 0) {
                const annualSavingsNeededPure = patrimonialObjective / yearsContribution;
                const percentageSavingsPure = (annualSavingsNeededPure / (income * 12)) * 100;
                pureSavingsText = `Para alcanzar este objetivo, si solo hubieras ahorrado (sin invertir), tendrías que haber ahorrado aproximadamente ${percentageSavingsPure.toFixed(0)}% de tus ingresos anuales durante los últimos ${yearsContributionDisplay} años.`; 

                const r = selectedInvestorProfileRate; 
                const n = yearsContribution;
                const fvAnnuityFactor = ((Math.pow(1 + r, n) - 1) / r);
                
                if (fvAnnuityFactor > 0) {
                    const annualSavingsNeededInvestment = patrimonialObjective / fvAnnuityFactor;
                    const percentageSavingsInvestment = (annualSavingsNeededInvestment / (income * 12)) * 100;
                    investmentSavingsText = `Sin embargo, si hubieras invertido ese dinero en un instrumento con un rendimiento promedio del ${(r * 100).toFixed(0)}% anual, solo necesitarías haber ahorrado aproximadamente ${percentageSavingsInvestment.toFixed(0)}% de tus ingresos anuales para alcanzar la misma meta. ¡La inversión puede hacer una gran diferencia!`; 
                } else {
                     investmentSavingsText = "No se pudo calcular el ahorro con inversión para los parámetros dados.";
                }
            } else {
                 pureSavingsText = "No se puede calcular el análisis de ahorro para una edad menor o igual a 26.5 años con esta fórmula.";
            }
            
            patrimonialDataForDisplay = { 
                ageUsed: age,
                incomeUsed: income,
                interestRateUsed: selectedInvestorProfileRate,
                objective: objectiveText,
                pureSavings: pureSavingsText,
                investmentSavings: investmentSavingsText,
                calculatedSuccessfully: true
            };
            return true; 
        }
        
        function getBarColorForPercentage(percentage) {
            if (percentage <= 20) return '#EF4444'; 
            if (percentage <= 40) return '#F97316'; 
            if (percentage <= 60) return '#EAB308'; 
            if (percentage <= 80) return '#84CC16'; 
            return '#22C55E'; 
        }
        
        function populateResultsLegend() {
            if (!legendItemsContainerEl) return;
            legendItemsContainerEl.innerHTML = ''; 

            resultsLevels.forEach(level => {
                const legendItemDiv = document.createElement('div');
                legendItemDiv.classList.add('results-legend-item');

                const colorSwatch = document.createElement('div');
                colorSwatch.classList.add('legend-color-swatch');
                colorSwatch.style.backgroundColor = level.barColor;
                legendItemDiv.appendChild(colorSwatch);

                const levelText = document.createElement('span');
                levelText.textContent = `${level.title} (${level.min}% - ${level.max}%)`;
                legendItemDiv.appendChild(levelText);

                legendItemsContainerEl.appendChild(legendItemDiv);
            });
        }
        
        function generateMailtoSummary() {
            const nl = "\r\n"; // Newline for mailto body
            let summary = `Resumen del Test para ${currentPersonalData.nombre || 'Usuario'}:${nl}${nl}`;
            
            const overallPercentage = parseFloat(scorePercentageEl.textContent);
            const resultLevel = resultsLevels.find(level => overallPercentage >= level.min && overallPercentage <= level.max);
            summary += `Resultado General: ${overallPercentage.toFixed(0)}% - ${resultLevel ? resultLevel.title : ''}${nl}${nl}`;
            
            if (patrimonialDataForDisplay && patrimonialDataForDisplay.calculatedSuccessfully) {
                 summary += `Objetivo Patrimonial Calculado: ${patrimonialDataForDisplay.objective.split(': ')[1]}${nl}${nl}`;
            }

            summary += `Resultados por Módulo:${nl}`;
            quizSections.forEach(section => {
                const percentage = sectionScores[section.title] !== undefined ? sectionScores[section.title] : 0;
                summary += `- ${section.title}: ${percentage.toFixed(0)}%${nl}`;
            });
            
            return summary;
        }

        function generateMailtoLink(summary) {
            const recipient = "test@arvfinplanner.com.mx";
            const subject = `Resultados del test - ${currentPersonalData.nombre || 'Usuario'}`;
            return `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(summary)}`;
        }


        function displayMotivationalText(type, ctaButtonsDiv) {
            const existingMotivationalText = finalPatrimonialResultsContainerEl.querySelector('.motivational-text');
            if (existingMotivationalText) {
                existingMotivationalText.remove();
            }
             
            ctaButtonsDiv.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains('btn-cta-achieved')) {
                    btn.style.backgroundColor = 'var(--color-cta-achieved-bg)';
                    btn.style.color = 'var(--color-cta-achieved-text)';
                    btn.style.borderColor = 'var(--color-cta-achieved-border)';
                } else if (btn.classList.contains('btn-cta-not-achieved')) {
                     btn.style.backgroundColor = 'var(--color-cta-not-achieved-bg)';
                     btn.style.color = 'var(--color-cta-not-achieved-text)';
                     btn.style.borderColor = 'var(--color-cta-not-achieved-border)';
                }
            });

            const summary = generateMailtoSummary();
            const mailtoLink = generateMailtoLink(summary);

            const textDiv = document.createElement('div');
            textDiv.classList.add('motivational-text');
            if (type === 'achieved') {
                textDiv.innerHTML = `
                    <p class="font-semibold mb-2">¡Felicidades por alcanzar tu objetivo patrimonial!</p>
                    <p>Este es un gran logro y demuestra tu disciplina financiera. Ahora es el momento de asegurar que tu patrimonio siga creciendo y trabajando para ti. Podemos ayudarte a explorar estrategias de inversión avanzadas, optimización fiscal y planificación de legado para maximizar tus rendimientos y proteger lo que has construido.</p>
                    <p class="mt-3"><strong>¿Listo para el siguiente nivel?</strong> <a href="${mailtoLink}" class="font-bold underline hover:text-indigo-700">Contáctanos para una asesoría personalizada.</a></p>
                `;
                const achievedButton = ctaButtonsDiv.querySelector('.btn-cta-achieved');
                if (achievedButton) {
                    achievedButton.classList.add('active');
                    achievedButton.style.backgroundColor = 'var(--color-cta-achieved-active-bg)';
                    achievedButton.style.color = 'var(--color-cta-achieved-active-text)';
                    achievedButton.style.borderColor = 'var(--color-cta-achieved-active-bg)';
                }


            } else if (type === 'notAchieved') {
                textDiv.innerHTML = `
                    <p class="font-semibold mb-2">¡No te desanimes! Estás en el camino correcto al buscar mejorar.</p>
                    <p>Alcanzar tu objetivo patrimonial es un viaje, y cada paso cuenta. Identificar dónde te encuentras es el primer gran paso. Podemos ayudarte a crear un plan de ahorro e inversión personalizado, optimizar tu presupuesto y establecer estrategias claras para que alcances tus metas financieras más rápido de lo que imaginas.</p>
                    <p class="mt-3"><strong>¿Listo para tomar el control y construir tu futuro?</strong> <a href="${mailtoLink}" class="font-bold underline hover:text-indigo-700">Hablemos sobre cómo podemos ayudarte.</a></p>
                `;
                const notAchievedButton = ctaButtonsDiv.querySelector('.btn-cta-not-achieved');
                if (notAchievedButton) {
                    notAchievedButton.classList.add('active');
                    notAchievedButton.style.backgroundColor = 'var(--color-cta-not-achieved-active-bg)';
                    notAchievedButton.style.color = 'var(--color-cta-not-achieved-active-text)';
                    notAchievedButton.style.borderColor = 'var(--color-cta-not-achieved-active-bg)';
                }
            }
            ctaButtonsDiv.parentNode.insertBefore(textDiv, ctaButtonsDiv.nextSibling);
            scrollToTop(textDiv); 
        }

        function generatePersonalDataNarrative() {
            const paragraphs = [];
            let currentParagraph = [];
            const data = currentPersonalData;

            // Group 1
            if (data.edad) {
                currentParagraph.push(`Considerando tu edad de ${data.edad}, ${personalDataObservations.edad[data.edad]}`);
            }
            if (data.estadoCivil) {
                currentParagraph.push(`Pasando a otro aspecto importante, como persona ${data.estadoCivil.toLowerCase()}, ${personalDataObservations.estadoCivil[data.estadoCivil]}`);
            }
            if (data.dependientes) {
                const linkingPhrase = data.dependientes === "Sí" ? "Adicionalmente, el tener dependientes económicos implica que tu responsabilidad financiera es mayor." : "Un factor adicional a considerar es que no tienes dependientes económicos.";
                currentParagraph.push(`${linkingPhrase} ${personalDataObservations.dependientes[data.dependientes]}`);
            }
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
                currentParagraph = [];
            }
            
            // Group 2
            if (data.vidaLaboral) {
                currentParagraph.push(`Con ${data.vidaLaboral} años de experiencia laboral, ${personalDataObservations.vidaLaboral}`);
            }
            if (data.ocupacion) {
                let ocupacionText = personalDataObservations.ocupacion[data.ocupacion];
                if(data.ocupacion.includes('(especificar)') && data.ocupacion_specify) {
                    ocupacionText += ` Específicamente, tu ocupación es ${data.ocupacion_specify}.`;
                }
                currentParagraph.push(`Tu ocupación principal como ${data.ocupacion.replace(' (especificar)', '').toLowerCase()} es un elemento clave. ${ocupacionText}`);
            }
             if (data.otraFuenteIngreso) {
                let ingresoText = personalDataObservations.otraFuenteIngreso[data.otraFuenteIngreso];
                if(data.otraFuenteIngreso.includes('(especificar)') && data.otraFuenteIngreso_specify) {
                    ingresoText += ` Tu otra fuente de ingresos es: ${data.otraFuenteIngreso_specify}.`;
                }
                currentParagraph.push(`Respecto a otras fuentes de ingreso, ${ingresoText}`);
            }
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
                currentParagraph = [];
            }

            // Group 3
            if (data.vivienda) {
                 currentParagraph.push(`Tu situación de vivienda, siendo ${data.vivienda.toLowerCase()}, también impacta tus finanzas. ${personalDataObservations.vivienda[data.vivienda]}`);
            }
            if(data.transporte) {
                currentParagraph.push(`El tipo de transporte que utilizas, ${data.transporte.toLowerCase()}, es otro gasto a considerar. ${personalDataObservations.transporte[data.transporte]}`);
            }
             if (data.fondoEmergencia) {
                currentParagraph.push(`Un pilar fundamental de las finanzas personales es el fondo de emergencia. En tu caso, ${personalDataObservations.fondoEmergencia[data.fondoEmergencia]}`);
            }
            if(data.deudas){
                currentParagraph.push(`En cuanto a deudas, la gestión de estas es un aspecto crucial. ${personalDataObservations.deudas[data.deudas]}`);
            }
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
                currentParagraph = [];
            }

            // Group 4
            if(data.preocupacion){
                currentParagraph.push(`Has mencionado que tu principal preocupación es: "${data.preocupacion.toLowerCase()}". ${personalDataObservations.preocupacion[data.preocupacion]}`);
            }
            if(data.conocimientosFinancieros){
                currentParagraph.push(`Finalmente, tu nivel de conocimiento sobre finanzas personales, que calificas como ${data.conocimientosFinancieros.toLowerCase()}, es un indicador importante. ${personalDataObservations.conocimientosFinancieros[data.conocimientosFinancieros]}`);
            }
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }

            return paragraphs;
        }


        function showResults() {
            if (!moduleChartContainerEl || !finalPatrimonialResultsContainerEl) return;
            moduleChartContainerEl.innerHTML = ''; 
            finalPatrimonialResultsContainerEl.innerHTML = ''; 
            if(personalDataNarrativeTextEl) personalDataNarrativeTextEl.innerHTML = '';


            const userName = currentPersonalData.nombre || "Usuario"; 
            if(resultsScreenTitleEl) resultsScreenTitleEl.textContent = `¡Tus Resultados Están Aquí, ${userName}!`;


            let finalOverallScore = 0;
            for (const questionId in userAnswers) {
                if (userAnswers.hasOwnProperty(questionId) && userAnswers[questionId].score !== undefined) { 
                    let isQuizQ = false;
                    for(const section of quizSections) {
                        if (section.questions.find(q => q.id === questionId)) {
                            isQuizQ = true;
                            break;
                        }
                    }
                    if(isQuizQ) {
                        finalOverallScore += userAnswers[questionId].score;
                    }
                }
            }
            const maxOverallScore = totalQuizQuestions * 3; 
            const overallPercentage = maxOverallScore > 0 ? (finalOverallScore / maxOverallScore) * 100 : 0;

            if(scorePercentageEl) scorePercentageEl.textContent = `${overallPercentage.toFixed(0)}%`;
            
            const overallLevelColor = getBarColorForPercentage(overallPercentage);
            if (overallPercentageBoxEl) {
                overallPercentageBoxEl.style.backgroundColor = overallLevelColor;
            }

            quizSections.forEach(section => {
                const percentage = sectionScores[section.title] !== undefined ? sectionScores[section.title] : 0;
                const barColor = getBarColorForPercentage(percentage);
                
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('bar-chart-item');

                const labelSpan = document.createElement('span');
                labelSpan.classList.add('bar-chart-label');
                labelSpan.textContent = section.title; 
                itemDiv.appendChild(labelSpan);

                const barContainerDiv = document.createElement('div');
                barContainerDiv.classList.add('bar-container');
                
                const barFillDiv = document.createElement('div');
                barFillDiv.classList.add('bar-fill');
                barFillDiv.style.width = `${percentage.toFixed(0)}%`;
                barFillDiv.style.backgroundColor = barColor; 
                
                const percentageTextSpan = document.createElement('span');
                percentageTextSpan.classList.add('bar-percentage-text');
                percentageTextSpan.textContent = `${percentage.toFixed(0)}%`;
                barFillDiv.appendChild(percentageTextSpan);

                barContainerDiv.appendChild(barFillDiv);
                itemDiv.appendChild(barContainerDiv);
                moduleChartContainerEl.appendChild(itemDiv);
            });

            const resultLevel = resultsLevels.find(level => overallPercentage >= level.min && overallPercentage <= level.max);
            if (resultLevel) {
                if(resultsTitleEl) resultsTitleEl.textContent = resultLevel.title;
                if(resultsCommentEl) resultsCommentEl.textContent = resultLevel.comment;
                if(resultsRecommendationEl) resultsRecommendationEl.textContent = `Recomendación: ${resultLevel.recommendation}`;
                if(resultsMessageContainerEl) { 
                    resultsMessageContainerEl.className = `results-message-container p-4 ${resultLevel.colorClass.replace(/border-\w+-\d+/, '').replace(/bg-\w+-\d+/, 'bg-opacity-10')} border-l-4 ${resultLevel.colorClass.match(/border-\w+-\d+/)[0]}`;
                }
            }

            const narrativeParagraphs = generatePersonalDataNarrative();
            if (narrativeParagraphs.length > 0 && personalDataNarrativeContainerEl && personalDataNarrativeTextEl) {
                narrativeParagraphs.forEach(pText => {
                    const pElement = document.createElement('p');
                    pElement.textContent = pText;
                    personalDataNarrativeTextEl.appendChild(pElement);
                });
                personalDataNarrativeContainerEl.classList.remove('hidden');
            }


            if (patrimonialDataForDisplay && patrimonialDataForDisplay.calculatedSuccessfully) {
                const patrimonialTitle = document.createElement('h3');
                patrimonialTitle.textContent = "Análisis de Objetivo Patrimonial";
                finalPatrimonialResultsContainerEl.appendChild(patrimonialTitle);

                const numeroMagicoP = document.createElement('p');
                numeroMagicoP.classList.add('numero-magico');
                numeroMagicoP.textContent = patrimonialDataForDisplay.objective.split(': $')[1]; 
                finalPatrimonialResultsContainerEl.appendChild(numeroMagicoP);

                const numeroMagicoLabelP = document.createElement('p');
                numeroMagicoLabelP.classList.add('numero-magico-label');
                numeroMagicoLabelP.textContent = "Tu patrimonio mínimo recomendado es:";
                finalPatrimonialResultsContainerEl.insertBefore(numeroMagicoLabelP, numeroMagicoP); 
                
                const objectiveIntroP = document.createElement('p');
                objectiveIntroP.innerHTML = `Basado en una edad de <strong>${patrimonialDataForDisplay.ageUsed} años</strong>, un ingreso mensual promedio de <strong>$${patrimonialDataForDisplay.incomeUsed.toLocaleString('es-MX', {minimumFractionDigits: 0, maximumFractionDigits: 0})} MXN</strong> y una tasa de inversión del <strong>${(patrimonialDataForDisplay.interestRateUsed * 100).toFixed(0)}% anual</strong>:`;
                finalPatrimonialResultsContainerEl.appendChild(objectiveIntroP);


                const pureSavingsP = document.createElement('p');
                pureSavingsP.textContent = patrimonialDataForDisplay.pureSavings;
                finalPatrimonialResultsContainerEl.appendChild(pureSavingsP);

                const investmentSavingsP = document.createElement('p');
                investmentSavingsP.textContent = patrimonialDataForDisplay.investmentSavings;
                finalPatrimonialResultsContainerEl.appendChild(investmentSavingsP);
                
                const noteP = document.createElement('p');
                noteP.classList.add('text-xs', 'mt-4');
                noteP.innerHTML = "<strong>Nota:</strong> Este es un estimado basado en la fórmula proporcionada. Para una planificación más detallada, te recomendamos hablar con un asesor financiero.";
                finalPatrimonialResultsContainerEl.appendChild(noteP);

                const ctaButtonsDiv = document.createElement('div');
                ctaButtonsDiv.classList.add('patrimonial-cta-buttons');
                
                const achievedBtn = document.createElement('button');
                achievedBtn.classList.add('btn', 'btn-cta-achieved', 'flex-1'); 
                achievedBtn.innerHTML = '¡Ya he logrado ese objetivo! &#x1F60A;'; 
                achievedBtn.addEventListener('click', () => displayMotivationalText('achieved', ctaButtonsDiv));
                ctaButtonsDiv.appendChild(achievedBtn);

                const notAchievedBtn = document.createElement('button');
                notAchievedBtn.classList.add('btn', 'btn-cta-not-achieved', 'flex-1');
                notAchievedBtn.innerHTML = '¡Aún no lo logro! &#x1F622;'; 
                notAchievedBtn.addEventListener('click', () => displayMotivationalText('notAchieved', ctaButtonsDiv));
                ctaButtonsDiv.appendChild(notAchievedBtn);
                
                finalPatrimonialResultsContainerEl.appendChild(ctaButtonsDiv);


            } else if (patrimonialDataForDisplay && !patrimonialDataForDisplay.calculatedSuccessfully) {
                 const errorMessageP = document.createElement('p');
                 errorMessageP.textContent = patrimonialDataForDisplay.message || "No se pudo calcular el objetivo patrimonial. Verifica los datos ingresados.";
                 errorMessageP.classList.add('text-sm', 'text-red-600', 'text-center', 'p-4', 'border', 'border-red-300', 'bg-red-50', 'rounded-md');
                 finalPatrimonialResultsContainerEl.appendChild(errorMessageP);
            } else {
                 const noCalcMessage = document.createElement('p');
                 noCalcMessage.textContent = "No se ingresaron datos para el cálculo del objetivo patrimonial.";
                 noCalcMessage.classList.add('text-sm', 'text-gray-600', 'text-center', 'p-4');
                 finalPatrimonialResultsContainerEl.appendChild(noCalcMessage);
            }
            
            populateResultsLegend(); 
            showScreen(resultsScreen); 
        }
        
        function collectPersonalData() {
            let allAnswered = true;
            let missingFieldName = "";

            for (const pdQuestion of personalDataQuestions) {
                let isAnswered = false;
                if (pdQuestion.type === 'text' || pdQuestion.type === 'number') {
                    if (currentPersonalData[pdQuestion.id] && currentPersonalData[pdQuestion.id].trim() !== '') {
                        isAnswered = true;
                    }
                } else if (pdQuestion.type === 'radio') {
                    if (currentPersonalData[pdQuestion.id] !== undefined) {
                        isAnswered = true;
                        if (currentPersonalData[pdQuestion.id].includes('(especificar)')) {
                            const specifyKey = `${pdQuestion.id}_specify`;
                            if (!currentPersonalData[specifyKey] || currentPersonalData[specifyKey].trim() === '') {
                                isAnswered = false; 
                                missingFieldName = `Por favor, completa el campo para "${pdQuestion.question}"`;
                            }
                        }
                    }
                }

                if (!isAnswered) {
                    allAnswered = false;
                    if (!missingFieldName) {
                         missingFieldName = `Por favor, responde la pregunta: "${pdQuestion.question}"`;
                    }
                    break; 
                }
            }

            if (!allAnswered) {
                if(personalDataErrorEl) {
                    personalDataErrorEl.textContent = missingFieldName;
                    personalDataErrorEl.classList.remove('hidden');
                }
                console.error(missingFieldName);
            } else {
                 if(personalDataErrorEl) {
                    personalDataErrorEl.classList.add('hidden');
                    personalDataErrorEl.textContent = '';
                 }
            }
            return allAnswered;
        }

        async function downloadResultsPDF() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                console.error("jsPDF library is not loaded.");
                alert("La librería para generar PDF no está cargada. Por favor, recarga la página.");
                return;
            }

            if(loadingTextEl) loadingTextEl.textContent = "Preparando PDF...";
            showScreen(loadingScreenEl);

            // --- CÓDIGO MODIFICADO ---
            // Se reemplaza la carga de imagen por la cadena Base64 para evitar errores de CORS.
            const logoDataUrl = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAYAAADL1t+KAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAEmmlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSfvu78nIGlkPSdXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQnPz4KPHg6eG1wbWV0YSB4bWxuczp4PSdhZG9iZTpuczptZXRhLyc+CjxyZGY6UkRGIHhtbG5zOnJkZj0naHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyc+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczpBdHRyaWI9J2h0dHA6Ly9ucy5hdHRyaWJ1dGlvbi5jb20vYWRzLzEuMC8nPgogIDxBdHRyaWI6QWRzPgogICA8cmRmOlNlcT4KICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0nUmVzb3VyY2UnPgogICAgIDxBdHRyaWI6Q3JlYXRlZD4yMDI1LTAyLTAyPC9BdHRyaWI6Q3JlYXRlZD4KICAgICA8QXR0cmliOkV4dElkPmEyZGZkNjZjLWRkODQtNDlhNC04MGJjLTM4NjcwZTlkMjk0MDwvQXR0cmliOkV4dElkPgogICAgIDxBdHRyaWI6RmJJZD41MjUyNjU5MTQxNzk1ODA8L0F0dHJpYjpGYklkPgogICAgIDxBdHRyaWI6VG91Y2hUeXBlPjI8L0F0dHJpYjpUb3VjaFR5cGU+CiAgICA8L3JkZjpsaT4KICAgPC9yZGY6U2VxPgogIDwvQXR0cmliOkFkcz4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PScnCiAgeG1sbnM6ZGM9J2h0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvJz4KICA8ZGM6dGl0bGU+CiAgIDxyZGY6QWx0PgogICAgPHJkZjpsaSB4bWw6bGFuZz0neC1kZWZhdWx0Jz5MT0dPIEFSViAtIDE8L3JkZjpsaT4KICAgPC9yZGY6QWx0PgogIDwvZGM6dGl0bGU+CiA8L3JkZjpEZXNjcmlwdGlvbj4KCiA8cmRmOkRlc2NyaXB0aW9uIHJkZjph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';

            // --- FIN DEL CÓDIGO MODIFICADO ---

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const lineSpacing = 7;
                const sectionSpacing = 10;
                const paragraphSpacing = 4;
                const margin = 15;
                const maxLineWidth = doc.internal.pageSize.getWidth() - margin * 2;
                const logoHeight = 12;
                const tempImg = new Image();
                tempImg.src = logoDataUrl;
                const logoWidth = (logoHeight * tempImg.width) / tempImg.height;
                let yPos;

                const addHeaderAndFooter = (logoImgData) => {
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        const pageHeight = doc.internal.pageSize.getHeight();
                        // Header
                        try {
                            if (logoImgData) {
                                doc.addImage(logoImgData, 'PNG', margin, 10, logoWidth, logoHeight);
                            }
                        } catch (e) {
                            console.error("Error al agregar el logo al PDF:", e);
                        }
                        
                        // Footer
                        const footerY = pageHeight - 25;
                        doc.setLineWidth(0.2);
                        doc.line(margin, footerY, maxLineWidth + margin, footerY);
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        doc.text("Alan Villegas - Asesor Financiero y de Seguros", margin, footerY + 10);
                        doc.text("alan@arvfinplanner.com.mx", margin, footerY + 14);
                        doc.text("5520322677 | linktr.ee/arvfinplanner", margin, footerY + 18);
                        
                        const pageNumText = `Página ${i} de ${totalPages}`;
                        doc.text(pageNumText, maxLineWidth + margin, footerY + 10, { align: 'right' });
                        doc.setTextColor(0);
                    }
                };
                
                function checkPageBreak(currentY, requiredSpace) {
                    const pageHeight = doc.internal.pageSize.getHeight();
                    if (currentY + requiredSpace > pageHeight - 30) { 
                        doc.addPage();
                        return 30;
                    }
                    return currentY;
                }
                
                // --- PÁGINA 1: Resultados Principales ---
                yPos = 35; 

                const titleFont = 'Helvetica'; 
                const textFont = 'Helvetica'; 

                doc.setFont(titleFont, 'bold'); 
                doc.setFontSize(16); 
                const userNameForPDF = currentPersonalData.nombre ? `, ${currentPersonalData.nombre}` : "";
                doc.text(`Resultados del Test de Finanzas Personales${userNameForPDF}`, doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                yPos += sectionSpacing * 1.5;

                const columnWidth = (maxLineWidth - 10) / 2; 
                const leftColumnX = margin;
                const rightColumnX = margin + columnWidth + 10;
                let yPosLeft = yPos;
                let yPosRight = yPos;

                doc.setFont(titleFont, 'bold').setFontSize(12);
                doc.setFillColor(134, 51, 153); 
                doc.setTextColor(255, 255, 255);
                doc.rect(leftColumnX, yPosLeft - 5, columnWidth, 8, 'F');
                doc.text("Resultados por módulos", leftColumnX + columnWidth / 2, yPosLeft, { align: 'center' });
                yPosLeft += 12;
                doc.setTextColor(0,0,0); 

                quizSections.forEach(section => {
                    const percentage = sectionScores[section.title] !== undefined ? sectionScores[section.title] : 0;
                    const barColorHex = getBarColorForPercentage(percentage);
                    const barHeight = 7; 
                    const textYOffset = barHeight / 2 + 2; 
                    doc.setFont(textFont, 'normal').setFontSize(9);
                    doc.text(section.title, leftColumnX, yPosLeft + textYOffset); 
                    const barX = leftColumnX + 35; 
                    const barW = columnWidth - 45;  
                    const filledBarW = (barW * percentage) / 100;
                    doc.setFillColor(226, 232, 240); 
                    doc.rect(barX, yPosLeft, barW, barHeight, 'F'); 
                    doc.setFillColor(barColorHex); 
                    doc.rect(barX, yPosLeft, filledBarW, barHeight, 'F');
                    doc.setFontSize(8).setTextColor(50,50,50);
                    doc.text(`${percentage.toFixed(0)}%`, barX + barW + 2, yPosLeft + textYOffset); 
                    yPosLeft += 12; 
                });

                doc.setFont(textFont, 'normal').setFontSize(10);
                doc.setTextColor(74, 85, 104); 
                doc.text("Tu resultado general es:", rightColumnX + columnWidth / 2, yPosRight, { align: 'center' });
                yPosRight += 8;
                const overallPercentage = parseFloat(scorePercentageEl.textContent);
                const overallLevelColorHex = getBarColorForPercentage(overallPercentage);
                doc.setFillColor(overallLevelColorHex);
                const boxSize = 25;
                doc.rect(rightColumnX + columnWidth/2 - boxSize/2, yPosRight, boxSize, boxSize, 'F');
                doc.setFont(titleFont, 'bold').setFontSize(18).setTextColor(255,255,255);
                doc.text(`${overallPercentage.toFixed(0)}%`, rightColumnX + columnWidth / 2, yPosRight + boxSize/2 + 6, { align: 'center' });
                yPosRight += boxSize + 10;
                doc.setTextColor(0,0,0);

                const resultLevel = resultsLevels.find(level => overallPercentage >= level.min && overallPercentage <= level.max);
                if (resultLevel) {
                    doc.setFont(titleFont, 'bold').setFontSize(12);
                    const titleLines = doc.splitTextToSize(resultLevel.title, columnWidth);
                    doc.text(titleLines, rightColumnX + columnWidth/2, yPosRight, {align: 'center'});
                    yPosRight += (titleLines.length * lineSpacing * 0.8) + 4;
                    
                    doc.setFont(textFont, 'normal').setFontSize(9);
                    const commentText = doc.splitTextToSize(resultLevel.comment, columnWidth);
                    doc.text(commentText, rightColumnX, yPosRight);
                    yPosRight += (commentText.length * lineSpacing * 0.9) + 4;
                    
                    doc.setFont(textFont, 'bold').setFontSize(9);
                    const recText = doc.splitTextToSize(`Recomendación: ${resultLevel.recommendation}`, columnWidth);
                    doc.text(recText, rightColumnX, yPosRight);
                    yPosRight += (recText.length * lineSpacing * 0.9);
                }

                yPos = Math.max(yPosLeft, yPosRight) + sectionSpacing;
                yPos = checkPageBreak(yPos, 40);

                doc.setFont(titleFont, 'bold').setFontSize(12);
                doc.setFillColor(134, 51, 153); 
                doc.setTextColor(255,255,255);
                doc.rect(margin, yPos - 5, maxLineWidth, 10, 'F');
                doc.text("Guía de Niveles y Colores", margin + maxLineWidth/2, yPos, {align: 'center'});
                yPos += 12;
                doc.setTextColor(0,0,0);

                doc.setFont(textFont, 'normal').setFontSize(9);
                resultsLevels.forEach(level => {
                    yPos = checkPageBreak(yPos, lineSpacing * 0.9);
                    const barColorHex = level.barColor; 
                    doc.setFillColor(barColorHex);
                    doc.rect(margin, yPos-3, 5, 5, 'F');
                    doc.text(`${level.title} (${level.min}% - ${level.max}%)`, margin + 8, yPos);
                    yPos += lineSpacing * 0.9;
                });

                // --- Salto de página para la Narrativa ---
                doc.addPage();
                yPos = 30;

                // --- Sección de Narrativa de Datos Personales ---
                const narrativeParagraphs = generatePersonalDataNarrative();
                if (narrativeParagraphs.length > 0) {
                    yPos = checkPageBreak(yPos, 20);
                    doc.setFont(titleFont, 'bold').setFontSize(12);
                    doc.setFillColor(134, 51, 153);
                    doc.setTextColor(255, 255, 255);
                    doc.rect(margin, yPos - 5, maxLineWidth, 10, 'F');
                    doc.text("Tu Perfil Financiero Detallado", doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                    yPos += 18;
                    doc.setTextColor(0, 0, 0);

                    doc.setFont(textFont, 'normal').setFontSize(10);
                    narrativeParagraphs.forEach(p => {
                        const splitNarrative = doc.splitTextToSize(p, maxLineWidth);
                        yPos = checkPageBreak(yPos, splitNarrative.length * (lineSpacing * 0.8));
                        doc.text(splitNarrative, margin, yPos);
                        yPos += (splitNarrative.length * (lineSpacing * 0.8)) + paragraphSpacing;
                    });
                }
                
                // --- Salto de página para lo Patrimonial ---
                doc.addPage();
                yPos = 30;

                // --- Sección Patrimonial ---
                if (patrimonialDataForDisplay && patrimonialDataForDisplay.calculatedSuccessfully) { 
                    yPos = checkPageBreak(yPos, 60); 
                    doc.setFont(titleFont, 'bold').setFontSize(12);
                    doc.setFillColor(134, 51, 153); 
                    doc.setTextColor(255,255,255);
                    doc.rect(margin, yPos - 5, maxLineWidth, 10, 'F'); 
                    doc.text("Análisis de Objetivo Patrimonial", margin + maxLineWidth/2, yPos, {align: 'center'}); 
                    yPos += 20; 
                    doc.setTextColor(0,0,0);
                    
                    doc.setFont(titleFont, 'bold').setFontSize(28).setTextColor(231, 0, 76); 
                    const numeroMagicoText = patrimonialDataForDisplay.objective.split(': $')[1];
                    doc.text(numeroMagicoText, doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' }); 
                    yPos += 10;
                    doc.setFont(textFont, 'normal').setFontSize(10).setTextColor(85,85,85);
                    doc.text("Tu patrimonio mínimo recomendado es:", doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' }); 
                    yPos += 15;
                    
                    doc.setFont(textFont, 'normal').setFontSize(9);
                    const introText = `Basado en una edad de ${patrimonialDataForDisplay.ageUsed} años, un ingreso mensual de $${patrimonialDataForDisplay.incomeUsed.toLocaleString('es-MX', {minimumFractionDigits: 0, maximumFractionDigits: 0})} MXN y una tasa de inversión del ${(patrimonialDataForDisplay.interestRateUsed * 100).toFixed(0)}%:`;
                    const splitIntro = doc.splitTextToSize(introText, maxLineWidth);
                    doc.text(splitIntro, margin, yPos);
                    yPos += splitIntro.length * (lineSpacing * 0.9) + 2;

                    if (patrimonialDataForDisplay.pureSavings) {
                        const pureSavingsPDFText = doc.splitTextToSize(patrimonialDataForDisplay.pureSavings, maxLineWidth);
                        doc.text(pureSavingsPDFText, margin, yPos);
                        yPos += pureSavingsPDFText.length * (lineSpacing * 0.9) + 2;
                    }
                    if (patrimonialDataForDisplay.investmentSavings) {
                        const investmentSavingsPDFText = doc.splitTextToSize(patrimonialDataForDisplay.investmentSavings, maxLineWidth);
                        doc.text(investmentSavingsPDFText, margin, yPos);
                        yPos += investmentSavingsPDFText.length * (lineSpacing * 0.9) + 2;
                    }
                    
                    yPos += 5;
                    doc.setFontSize(8).setTextColor(100);
                    const noteText = "Nota: El cálculo patrimonial es una estimación referencial. Para una planificación más detallada, te recomendamos hablar con un asesor financiero.";
                    doc.text(doc.splitTextToSize(noteText, maxLineWidth), margin, yPos);
                    yPos += (lineSpacing * 0.9 * 2) + sectionSpacing;

                    const summary = generateMailtoSummary();
                    const mailtoLink = generateMailtoLink(summary);
                    yPos = checkPageBreak(yPos, 40);
                    doc.setFont(titleFont, 'bold').setFontSize(10);
                    doc.text("Siguientes Pasos:", margin, yPos);
                    yPos += (lineSpacing * 0.9) * 2;

                    doc.setFont(textFont, 'normal').setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    const achievedText = "Si ya lograste tu objetivo: ¡Felicidades! Este es un gran logro. Ahora es el momento de asegurar que tu patrimonio siga creciendo. Podemos ayudarte a explorar estrategias avanzadas para maximizar tus rendimientos y proteger lo que has construido. ";
                    const notAchievedText = "Si aún no lo logras: ¡No te desanimes! Identificar dónde te encuentras es el primer gran paso. Podemos ayudarte a crear un plan de ahorro e inversión personalizado para que alcances tus metas financieras más rápido de lo que imaginas. ";
                    const contactText = "Contáctanos para una asesoría personalizada.";

                    let textLinesAchieved = doc.splitTextToSize(achievedText, maxLineWidth - doc.getTextWidth(contactText) - 2);
                    doc.text(textLinesAchieved, margin, yPos);
                    let lastLineYAchieved = yPos + (textLinesAchieved.length - 1) * (lineSpacing * 0.9);
                    let lastLineXAchieved = margin + doc.getTextWidth(textLinesAchieved[textLinesAchieved.length - 1]) + 1;
                    doc.setTextColor(49, 130, 206).textWithLink(contactText, lastLineXAchieved, lastLineYAchieved, { url: mailtoLink });
                    doc.setTextColor(0, 0, 0);
                    yPos += textLinesAchieved.length * (lineSpacing * 0.9) + paragraphSpacing * 2;

                    let textLinesNotAchieved = doc.splitTextToSize(notAchievedText, maxLineWidth - doc.getTextWidth(contactText) - 2);
                     doc.text(textLinesNotAchieved, margin, yPos);
                    let lastLineYNotAchieved = yPos + (textLinesNotAchieved.length - 1) * (lineSpacing * 0.9);
                    let lastLineXNotAchieved = margin + doc.getTextWidth(textLinesNotAchieved[textLinesNotAchieved.length - 1]) + 1;
                    doc.setTextColor(49, 130, 206).textWithLink(contactText, lastLineXNotAchieved, lastLineYNotAchieved , { url: mailtoLink });
                    doc.setTextColor(0, 0, 0);

                }
                
                // --- Salto de página para las Respuestas del Test ---
                doc.addPage();
                yPos = 30;
                
                // --- Respuestas del Test Principal ---
                doc.setFont(titleFont, 'bold');
                doc.setFontSize(14);
                doc.text("Resumen de Tus Respuestas del Test", doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                yPos += sectionSpacing * 1.5;

                quizSections.forEach(section => {
                    yPos = checkPageBreak(yPos, 20); 
                    doc.setFont(titleFont, 'bold');
                    doc.setFontSize(11);
                    const sectionTitleText = doc.splitTextToSize(section.fullTitle, maxLineWidth);
                    doc.text(sectionTitleText, margin, yPos);
                    yPos += sectionTitleText.length * (lineSpacing * 0.9) + 4;

                    doc.setFont(textFont, 'normal');
                    doc.setFontSize(9);
                    section.questions.forEach(question => {
                        const qText = `P: ${question.text}`;
                        const splitQText = doc.splitTextToSize(qText, maxLineWidth);
                        yPos = checkPageBreak(yPos, (splitQText.length * (lineSpacing * 0.9)) * 2); 
                        
                        doc.text(splitQText, margin, yPos);
                        yPos += splitQText.length * (lineSpacing * 0.9);

                        const userAnswerObj = userAnswers[question.id];
                        const answerText = userAnswerObj && userAnswerObj.text ? `R: ${userAnswerObj.text}` : "R: No respondida";
                        const splitAText = doc.splitTextToSize(answerText, maxLineWidth - 10);
                        doc.setTextColor(85, 85, 85); 
                        doc.text(splitAText, margin + 10, yPos);
                        doc.setTextColor(0, 0, 0); 
                        yPos += splitAText.length * (lineSpacing * 0.9) + 6;
                    });
                    yPos += (lineSpacing * 0.9); 
                });

                // --- Agregar Encabezados y Pies de Página a todas las páginas ---
                addHeaderAndFooter(logoDataUrl);

                doc.save("Resultados_Test_Finanzas_Personales.pdf");

            } catch (error) {
                console.error("No se pudo generar el PDF:", error);
                alert("Hubo un error al generar el PDF. Por favor, revisa la consola para más detalles.");
            } finally {
                if(loadingTextEl) loadingTextEl.textContent = "Generando reporte...";
                showScreen(resultsScreen, true);
            }
        }

        // --- Event Listeners ---
        if(startQuizBtn) startQuizBtn.addEventListener('click', () => {
            if(initialScreen) screenHistory = [initialScreen.id]; 
            showScreen(disclaimerScreenEl); 
        });
        
        if(acceptDisclaimerBtnEl) acceptDisclaimerBtnEl.addEventListener('click', () => {
            currentPersonalData = {}; 
            loadPersonalDataQuestions();
            showScreen(personalDataScreen);
        });

        if(backBtnPersonalDataEl) backBtnPersonalDataEl.addEventListener('click', () => {
            goBack(); 
        });

        if(startMainQuizBtn) startMainQuizBtn.addEventListener('click', () => {
            if (collectPersonalData()) {
                currentSectionIndex = 0;
                userAnswers = {}; 
                sectionScores = {}; 
                totalAnsweredQuestions = 0; 
                patrimonialDataForDisplay = null; 
                loadSection(); 
                showScreen(quizScreen);
            } else {
                 if(personalDataErrorEl) scrollToTop(personalDataErrorEl);
            }
        });

        if(nextSectionBtn) nextSectionBtn.addEventListener('click', handleNextSection); 
        if(backBtnQuiz) backBtnQuiz.addEventListener('click', handleBackSection); 
        
        if(backBtnPatrimonialInput) backBtnPatrimonialInput.addEventListener('click', () => { 
             goBack(); 
        });

        if(generateReportBtnEl) generateReportBtnEl.addEventListener('click', () => { 
            const investorProfileSelected = investorProfileQuestionContainerEl.querySelector(`input[name="${investorProfileQuestion.id}"]:checked`);
            if (!investorProfileSelected) {
                if(investorProfileErrorEl) investorProfileErrorEl.classList.remove('hidden');
                console.error("Por favor, selecciona tu perfil de inversionista.");
                return;
            }
            if(investorProfileErrorEl) investorProfileErrorEl.classList.add('hidden');
            
            if (!calculatePatrimonialObjectiveData()) { 
                return; 
            }
            
            if(loadingTextEl) loadingTextEl.textContent = "Generando reporte...";
            showScreen(loadingScreenEl);
            setTimeout(() => {
                if (Object.keys(sectionScores).length === 0) { 
                   calculateAndStoreSectionScores(); 
                }
                showResults();
            }, quizConfig.loadingDelay);
        });
        
        if(downloadPdfBtn) downloadPdfBtn.addEventListener('click', downloadResultsPDF);

        if(restartQuizBtn) restartQuizBtn.addEventListener('click', () => {
            currentPersonalData = {};
            currentSectionIndex = 0;
            userAnswers = {};
            sectionScores = {};
            totalAnsweredQuestions = 0;
            patrimonialDataForDisplay = null; 
            if(progressBarEl) progressBarEl.style.width = '0%';
            if(currentAgeInput) currentAgeInput.value = '';
            if(avgMonthlyIncomeInput) avgMonthlyIncomeInput.value = '';
            selectedInvestorProfileRate = 0.06; 
            screenHistory = []; 
            showScreen(initialScreen);
        });

        // --- Initial Load ---
        showScreen(initialScreen);

    </script>
</body>
</html>
